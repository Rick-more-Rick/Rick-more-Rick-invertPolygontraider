<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DON Trading ‚Äî Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- ‚ïê‚ïê‚ïê FIREBASE (ya inicializado en tu app, pero si es standalone): ‚ïê‚ïê‚ïê -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>
    <!-- ‚ïê‚ïê‚ïê FIREBASE (ya inicializado en tu app, pero si es standalone): ‚ïê‚ïê‚ïê -->
    <style>
    :root{
    --bg0:#0a0b0e;--bg1:#101118;--bg2:#16171f;--bg3:#1c1d28;
    --bg-card:#131420;--bg-card-h:#191a28;--bg-glow:rgba(0,224,135,.03);
    --bd:#1e2033;--bd2:#2c2e48;--bd3:#3a3d5a;
    --t1:#eaebf2;--t2:#8c8fa6;--t3:#55586e;--t4:#3a3c50;
    --grn:#00e087;--grn-d:rgba(0,224,135,.1);--grn-g:rgba(0,224,135,.2);--grn-s:rgba(0,224,135,.5);
    --red:#ff4466;--red-d:rgba(255,68,102,.1);
    --yel:#ffc233;--yel-d:rgba(255,194,51,.1);
    --blu:#4d8dff;--blu-d:rgba(77,141,255,.1);
    --pur:#a855f7;--pur-d:rgba(168,85,247,.1);
    --org:#ff8c42;--org-d:rgba(255,140,66,.1);
    --r1:6px;--r2:10px;--r3:14px;--r4:20px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg0);color:var(--t1);min-height:100vh;overflow-x:hidden}
    ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:3px}

    /* ‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê */
    .topbar{
    display:flex;align-items:center;justify-content:space-between;
    padding:0 28px;height:56px;
    background:var(--bg1);border-bottom:1px solid var(--bd);
    position:sticky;top:0;z-index:100;
    backdrop-filter:blur(12px);
    }
    .top-l{display:flex;align-items:center;gap:20px}
    .logo{font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:700;letter-spacing:-.5px}
    .logo span{color:var(--grn)}
    .top-sep{width:1px;height:24px;background:var(--bd)}
    .top-nav{display:flex;gap:4px}
    .nav-btn{
    padding:7px 14px;font-size:12px;font-weight:600;color:var(--t3);
    background:transparent;border:none;border-radius:var(--r1);cursor:pointer;
    transition:all .2s;font-family:'Plus Jakarta Sans',sans-serif;
    }
    .nav-btn:hover{color:var(--t2);background:var(--bg2)}
    .nav-btn.on{color:var(--grn);background:var(--grn-d)}

    .top-r{display:flex;align-items:center;gap:10px}
    .top-acct{
    display:flex;align-items:center;gap:7px;padding:5px 12px;
    background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r1);
    font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--t2);
    max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .top-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
    .top-dot.on{background:var(--grn);box-shadow:0 0 6px var(--grn-s);animation:pu 2s infinite}
    .top-dot.off{background:var(--t4)}
    @keyframes pu{0%,100%{opacity:1}50%{opacity:.4}}

    .btn-connect-top{
    padding:6px 14px;background:var(--grn-d);border:1px solid rgba(0,224,135,.2);
    border-radius:var(--r1);color:var(--grn);font-size:11px;font-weight:700;
    font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all .2s;
    }
    .btn-connect-top:hover{background:var(--grn);color:#0a0b0e}

    .btn-sm{
    padding:5px 12px;background:transparent;border:1px solid var(--bd);
    border-radius:var(--r1);color:var(--t3);font-size:11px;
    font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all .15s;
    }
    .btn-sm:hover{border-color:var(--bd2);color:var(--t2)}
    .btn-sm.red:hover{border-color:var(--red);color:var(--red)}

    /* ‚ïê‚ïê‚ïê MAIN LAYOUT ‚ïê‚ïê‚ïê */
    .main-wrap{max-width:1440px;margin:0 auto;padding:24px 28px 60px}

    /* ‚ïê‚ïê‚ïê SECTIONS ‚ïê‚ïê‚ïê */
    .section{display:none;animation:fi .4s ease}
    .section.on{display:block}
    @keyframes fi{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* ‚ïê‚ïê‚ïê EMPTY STATE ‚Äî NO BROKER ‚ïê‚ïê‚ïê */
    .hero-connect{
    position:relative;overflow:hidden;
    background:linear-gradient(135deg,var(--bg-card) 0%,rgba(0,224,135,.04) 100%);
    border:1px solid var(--bd);border-radius:var(--r4);
    padding:48px;margin-bottom:28px;
    }
    .hero-connect::before{
    content:'';position:absolute;top:-80px;right:-80px;width:300px;height:300px;
    background:radial-gradient(circle,rgba(0,224,135,.06) 0%,transparent 70%);
    pointer-events:none;
    }
    .hero-tag{
    display:inline-flex;align-items:center;gap:6px;
    font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;
    color:var(--grn);background:var(--grn-d);
    padding:5px 12px;border-radius:20px;margin-bottom:20px;
    font-family:'JetBrains Mono',monospace;
    }
    .hero-tag .pulse{width:6px;height:6px;border-radius:50%;background:var(--grn);animation:pu 1.5s infinite}
    .hero-h{font-size:28px;font-weight:800;letter-spacing:-.5px;margin-bottom:10px;line-height:1.2}
    .hero-h em{font-style:normal;color:var(--grn)}
    .hero-p{color:var(--t2);font-size:14px;line-height:1.7;max-width:520px;margin-bottom:28px}
    .hero-features{display:flex;gap:20px;margin-bottom:32px;flex-wrap:wrap}
    .hero-feat{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--t2);font-family:'JetBrains Mono',monospace}
    .hero-feat .ico{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;background:var(--bg2);border:1px solid var(--bd)}
    .btn-hero{
    display:inline-flex;align-items:center;gap:8px;
    padding:14px 28px;background:var(--grn);color:#0a0b0e;
    border:none;border-radius:var(--r2);font-size:14px;font-weight:700;
    cursor:pointer;transition:all .25s;font-family:'Plus Jakarta Sans',sans-serif;
    }
    .btn-hero:hover{background:#00ff99;box-shadow:0 0 32px var(--grn-g);transform:translateY(-1px)}
    .btn-hero svg{width:16px;height:16px}
    .hero-note{margin-top:16px;font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace}

    /* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
    .modal-bg{
    position:fixed;inset:0;background:rgba(6,7,10,.85);backdrop-filter:blur(8px);
    display:none;align-items:center;justify-content:center;z-index:200;
    }
    .modal-bg.on{display:flex}
    .modal{
    background:var(--bg-card);border:1px solid var(--bd2);border-radius:var(--r4);
    padding:40px;width:500px;max-width:92vw;max-height:90vh;overflow-y:auto;
    animation:modalIn .3s ease;position:relative;
    }
    @keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
    .modal-close{
    position:absolute;top:16px;right:16px;width:32px;height:32px;
    background:var(--bg2);border:1px solid var(--bd);border-radius:8px;
    display:flex;align-items:center;justify-content:center;
    color:var(--t3);font-size:16px;cursor:pointer;transition:.15s;
    }
    .modal-close:hover{background:var(--bg3);color:var(--t1)}
    .modal-title{font-size:20px;font-weight:800;margin-bottom:6px}
    .modal-sub{color:var(--t3);font-size:12px;margin-bottom:28px;font-family:'JetBrains Mono',monospace}

    .fg{margin-bottom:16px}
    .fg label{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--t2);margin-bottom:7px}
    .fg .hint{font-weight:400;text-transform:none;letter-spacing:0;color:var(--t3);font-size:10px}
    .fg input,.fg select{
    width:100%;background:var(--bg2);border:1px solid var(--bd);
    border-radius:var(--r1);padding:11px 14px;color:var(--t1);
    font-family:'JetBrains Mono',monospace;font-size:13px;outline:none;transition:border .2s;
    }
    .fg input:focus,.fg select:focus{border-color:var(--grn);box-shadow:0 0 0 3px var(--grn-d)}
    .fg input::placeholder{color:var(--t4)}
    .fg select{cursor:pointer;-webkit-appearance:none;appearance:none}
    .frow{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    .btn-submit{
    width:100%;padding:13px;background:var(--grn);color:#0a0b0e;
    border:none;border-radius:var(--r1);font-size:14px;font-weight:700;
    cursor:pointer;transition:all .2s;margin-top:6px;font-family:'Plus Jakarta Sans',sans-serif;
    }
    .btn-submit:hover{background:#00ff99;box-shadow:0 0 24px var(--grn-g)}
    .btn-submit:disabled{opacity:.5;cursor:not-allowed}

    .err-msg{color:var(--red);font-size:12px;margin-top:12px;font-family:'JetBrains Mono',monospace;display:none;line-height:1.5}
    .info-box{margin-top:18px;padding:12px;border-radius:var(--r1);font-size:11px;line-height:1.7;font-family:'JetBrains Mono',monospace;background:var(--blu-d);border:1px solid rgba(77,141,255,.12);color:var(--t2)}
    .info-box strong{color:var(--blu)}

    /* ‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê */
    .loader{position:fixed;inset:0;background:rgba(10,11,14,.9);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:999}
    .loader.on{display:flex}
    .spin{width:36px;height:36px;border:3px solid var(--bd);border-top-color:var(--grn);border-radius:50%;animation:sp .7s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .loader-txt{margin-top:14px;font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--t3);text-align:center;line-height:1.5}

    /* ‚ïê‚ïê‚ïê SETTINGS SECTION ‚ïê‚ïê‚ïê */
    .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:800px}
    .setting-card{
    background:var(--bg-card);border:1px solid var(--bd);border-radius:var(--r3);
    padding:24px;transition:all .25s;
    }
    .setting-card:hover{border-color:var(--bd2)}
    .setting-card .sc-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:14px}
    .setting-card h3{font-size:14px;font-weight:700;margin-bottom:6px}
    .setting-card p{font-size:12px;color:var(--t3);line-height:1.6;margin-bottom:14px}
    .setting-btn{
    padding:8px 16px;font-size:11px;font-weight:700;border-radius:var(--r1);
    cursor:pointer;transition:all .2s;font-family:'JetBrains Mono',monospace;
    }
    .setting-btn.green{background:var(--grn-d);border:1px solid rgba(0,224,135,.2);color:var(--grn)}
    .setting-btn.green:hover{background:var(--grn);color:#0a0b0e}
    .setting-btn.red{background:var(--red-d);border:1px solid rgba(255,68,102,.15);color:var(--red)}
    .setting-btn.red:hover{background:var(--red);color:#fff}
    .setting-status{
    display:inline-flex;align-items:center;gap:5px;
    font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace;
    padding:4px 10px;border-radius:20px;margin-bottom:12px;
    }
    .setting-status.connected{background:var(--grn-d);color:var(--grn)}
    .setting-status.disconnected{background:var(--bg2);color:var(--t3)}

    /* ‚ïê‚ïê‚ïê DASHBOARD METRICS ‚ïê‚ïê‚ïê */
    .mgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(195px,1fr));gap:14px;margin-bottom:24px}
    .mc{
    background:var(--bg-card);border:1px solid var(--bd);border-radius:var(--r2);
    padding:18px 20px;transition:all .25s;position:relative;overflow:hidden;
    }
    .mc::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;opacity:0;transition:opacity .25s}
    .mc:hover{border-color:var(--bd2);transform:translateY(-1px)}.mc:hover::after{opacity:1}
    .mc.g::after{background:var(--grn)}.mc.r::after{background:var(--red)}.mc.b::after{background:var(--blu)}.mc.y::after{background:var(--yel)}.mc.p::after{background:var(--pur)}
    .ml{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:8px}
    .mv{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;line-height:1}
    .ms{font-size:11px;color:var(--t3);margin-top:6px;font-family:'JetBrains Mono',monospace}
    .pos{color:var(--grn)}.neg{color:var(--red)}.neu{color:var(--t1)}

    /* ‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê */
    .chart-wrap{background:var(--bg-card);border:1px solid var(--bd);border-radius:var(--r2);padding:20px;margin-bottom:24px;min-height:280px}
    .cv{width:100%;height:240px}

    .sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .st-title{font-size:14px;font-weight:700}
    .st-badge{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--t3);padding:3px 10px;background:var(--bg2);border-radius:var(--r1)}

    /* ‚ïê‚ïê‚ïê RINGS ‚ïê‚ïê‚ïê */
    .rings{display:flex;gap:20px;margin-bottom:24px;flex-wrap:wrap}
    .ring-card{background:var(--bg-card);border:1px solid var(--bd);border-radius:var(--r2);padding:24px;display:flex;align-items:center;gap:20px;flex:1;min-width:280px}
    .rsvg{width:110px;height:110px;flex-shrink:0}
    .ri h3{font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px}
    .ri .rv{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700}
    .ri .rd{font-size:11px;color:var(--t3);margin-top:5px;font-family:'JetBrains Mono',monospace}

    /* ‚ïê‚ïê‚ïê TABLE ‚ïê‚ïê‚ïê */
    .tw{background:var(--bg-card);border:1px solid var(--bd);border-radius:var(--r2);overflow:hidden}
    .tt{width:100%;border-collapse:collapse}
    .tt thead{background:var(--bg2)}
    .tt th{padding:11px 14px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);border-bottom:1px solid var(--bd)}
    .tt td{padding:11px 14px;border-bottom:1px solid var(--bd);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--t2)}
    .tt tbody tr:hover{background:var(--bg-card-h)}
    .ttype{display:inline-block;padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:.5px}
    .ttype.buy{background:var(--grn-d);color:var(--grn)}.ttype.sell{background:var(--red-d);color:var(--red)}

    /* ‚ïê‚ïê‚ïê P&L PERIOD ‚ïê‚ïê‚ïê */
    .pf{display:flex;gap:6px;margin-bottom:16px}
    .pb{padding:7px 14px;font-size:11px;font-weight:600;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r1);color:var(--t3);cursor:pointer;transition:.2s;font-family:'Plus Jakarta Sans',sans-serif}
    .pb:hover{color:var(--t2);border-color:var(--bd2)}.pb.on{color:var(--grn);border-color:var(--grn);background:var(--grn-d)}

    .banner{padding:10px 16px;background:var(--yel-d);border:1px solid rgba(255,194,51,.15);border-radius:var(--r1);margin-bottom:18px;font-size:11px;color:var(--yel);font-family:'JetBrains Mono',monospace;display:none;line-height:1.5}

    /* ‚ïê‚ïê‚ïê JOURNAL TABS ‚ïê‚ïê‚ïê */
    .j-tabs{display:flex;gap:4px;margin-bottom:20px;padding:4px;background:var(--bg2);border-radius:var(--r2);width:fit-content}
    .j-tab{
    padding:8px 18px;font-size:12px;font-weight:600;color:var(--t3);
    background:transparent;border:none;border-radius:var(--r1);
    cursor:pointer;transition:all .2s;font-family:'Plus Jakarta Sans',sans-serif;
    }
    .j-tab:hover{color:var(--t2)}
    .j-tab.on{color:var(--t1);background:var(--bg-card);box-shadow:0 1px 4px rgba(0,0,0,.2)}

    .jtp{display:none;animation:fi .3s ease}
    .jtp.on{display:block}

    @media(max-width:768px){
    .topbar{padding:0 14px;height:50px}.main-wrap{padding:16px 14px}
    .hero-connect{padding:28px}.hero-h{font-size:22px}
    .mgrid{grid-template-columns:repeat(2,1fr);gap:10px}.mc{padding:14px}.mv{font-size:18px}
    .settings-grid{grid-template-columns:1fr}.frow{grid-template-columns:1fr}
    .rings{flex-direction:column}.ring-card{min-width:auto}
    .modal{padding:28px}.top-acct{display:none}
    }
    </style>
    <!-- ‚ïê‚ïê‚ïê FIREBASE (ya inicializado en tu app, pero si es standalone): ‚ïê‚ïê‚ïê -->
</head>
<body>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="topbar">
    <div class="top-l">
        <div class="logo">DON<span>TRADING</span></div>
        <div class="top-sep"></div>
        <div class="top-nav">
        <button class="nav-btn on" data-s="journal" onclick="goSection('journal')">Journal</button>
        <button class="nav-btn" data-s="settings" onclick="goSection('settings')">Settings</button>
        </div>
    </div>
    <div class="top-r">
        <!-- Cuando NO est√° conectado -->
        <button class="btn-connect-top" id="topConnectBtn" onclick="openModal()">+ Conectar Broker</button>
        <!-- Cuando S√ç est√° conectado -->
        <div class="top-acct" id="topAcctInfo" style="display:none">
        <div class="top-dot on"></div>
        <span id="topAcctText">--</span>
        </div>
        <div class="top-acct" id="topBalance" style="display:none">--</div>
        <button class="btn-sm" id="topRefresh" onclick="refresh()" style="display:none">‚Üª</button>
    </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="main-wrap">

    <!-- ‚îÄ‚îÄ‚îÄ JOURNAL SECTION ‚îÄ‚îÄ‚îÄ -->
    <div class="section on" id="sec-journal">

        <!-- EMPTY STATE: no broker connected -->
        <div id="emptyState">
        <div class="hero-connect">
            <div class="hero-tag"><div class="pulse"></div> Opcional</div>
            <h2 class="hero-h">Conecta tu broker y desbloquea <em>tu Journal</em></h2>
            <p class="hero-p">
            Analiza tu rendimiento con m√©tricas autom√°ticas, curva de equity, P&L por periodo
            y historial completo de operaciones. Todo en tiempo real, directo desde tu MT4/MT5.
            </p>
            <div class="hero-features">
            <div class="hero-feat"><div class="ico">üìä</div> Win Rate & P.Factor</div>
            <div class="hero-feat"><div class="ico">üìà</div> Equity Curve</div>
            <div class="hero-feat"><div class="ico">üìÖ</div> P&L Diario/Semanal</div>
            <div class="hero-feat"><div class="ico">üîí</div> Solo lectura (seguro)</div>
            </div>
            <button class="btn-hero" onclick="openModal()">
            Conectar mi Broker
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </button>
            <div class="hero-note">Solo necesitas tu servidor, login y investor password de MT5</div>
        </div>
        </div>

        <!-- DASHBOARD: broker connected -->
        <div id="dashState" style="display:none">
        <div class="banner" id="banner">‚ö† MetaStats procesando. M√©tricas calculadas localmente.</div>

        <div class="j-tabs">
            <button class="j-tab on" data-jt="overview" onclick="goJTab('overview')">Overview</button>
            <button class="j-tab" data-jt="pnl" onclick="goJTab('pnl')">P&L</button>
            <button class="j-tab" data-jt="trades" onclick="goJTab('trades')">Trades</button>
        </div>

        <!-- OVERVIEW -->
        <div class="jtp on" id="jtp-overview">
            <div class="mgrid">
            <div class="mc g"><div class="ml">Net Profit</div><div class="mv" id="mProfit">--</div><div class="ms" id="mProfitS"></div></div>
            <div class="mc b"><div class="ml">Total Trades</div><div class="mv neu" id="mTrades">--</div><div class="ms" id="mTradesS"></div></div>
            <div class="mc g"><div class="ml">Win Rate</div><div class="mv" id="mWR">--</div><div class="ms" id="mWRS"></div></div>
            <div class="mc y"><div class="ml">Profit Factor</div><div class="mv neu" id="mPF">--</div><div class="ms" id="mPFS"></div></div>
            <div class="mc r"><div class="ml">Max Drawdown</div><div class="mv" id="mDD">--</div><div class="ms" id="mDDS"></div></div>
            <div class="mc p"><div class="ml">Avg Win / Loss</div><div class="mv neu" id="mAvg">--</div><div class="ms" id="mAvgS"></div></div>
            </div>
            <div class="rings">
            <div class="ring-card">
                <svg class="rsvg" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#1e2033" stroke-width="10"/><circle cx="60" cy="60" r="50" fill="none" stroke="#00e087" stroke-width="10" stroke-dasharray="314" stroke-dashoffset="314" stroke-linecap="round" transform="rotate(-90 60 60)" id="wrArc"/><text x="60" y="56" text-anchor="middle" fill="#eaebf2" font-size="22" font-family="JetBrains Mono" font-weight="700" id="wrTxt">--</text><text x="60" y="74" text-anchor="middle" fill="#55586e" font-size="10" font-family="JetBrains Mono">WIN RATE</text></svg>
                <div class="ri"><h3>Winning Trades</h3><div class="rv pos" id="rWins">--</div><div class="rd" id="rWinD">--</div></div>
            </div>
            <div class="ring-card">
                <svg class="rsvg" viewBox="0 0 120 120"><circle cx="60" cy="60" r="50" fill="none" stroke="#1e2033" stroke-width="10"/><circle cx="60" cy="60" r="50" fill="none" stroke="#4d8dff" stroke-width="10" stroke-dasharray="314" stroke-dashoffset="314" stroke-linecap="round" transform="rotate(-90 60 60)" id="lsArc"/><text x="60" y="56" text-anchor="middle" fill="#eaebf2" font-size="22" font-family="JetBrains Mono" font-weight="700" id="lsTxt">--</text><text x="60" y="74" text-anchor="middle" fill="#55586e" font-size="10" font-family="JetBrains Mono">LONG %</text></svg>
                <div class="ri"><h3>Long vs Short</h3><div class="rv" style="color:var(--blu)" id="rLongs">--</div><div class="rd" id="rLongD">--</div></div>
            </div>
            </div>
            <div class="sh"><div class="st-title">Equity Curve</div><div class="st-badge" id="eqBadge">--</div></div>
            <div class="chart-wrap"><canvas class="cv" id="eqCv"></canvas></div>
        </div>

        <!-- P&L -->
        <div class="jtp" id="jtp-pnl">
            <div class="sh"><div class="st-title">Profit & Loss</div></div>
            <div class="pf">
            <button class="pb on" data-p="daily" onclick="goPeriod('daily')">Daily</button>
            <button class="pb" data-p="weekly" onclick="goPeriod('weekly')">Weekly</button>
            <button class="pb" data-p="monthly" onclick="goPeriod('monthly')">Monthly</button>
            </div>
            <div class="chart-wrap"><canvas class="cv" id="plCv"></canvas></div>
            <div class="mgrid">
            <div class="mc g"><div class="ml">Best Day</div><div class="mv pos" id="bestD">--</div></div>
            <div class="mc r"><div class="ml">Worst Day</div><div class="mv neg" id="worstD">--</div></div>
            <div class="mc b"><div class="ml">Avg Daily P&L</div><div class="mv" id="avgD">--</div></div>
            <div class="mc y"><div class="ml">Profitable Days</div><div class="mv neu" id="profD">--</div></div>
            </div>
        </div>

        <!-- TRADES -->
        <div class="jtp" id="jtp-trades">
            <div class="sh"><div class="st-title">Trade History</div><div class="st-badge" id="tCnt">0</div></div>
            <div class="tw"><div style="max-height:560px;overflow-y:auto">
            <table class="tt"><thead><tr><th>Date</th><th>Symbol</th><th>Type</th><th>Vol</th><th>Open</th><th>Close</th><th>P&L</th><th>Pips</th><th>Duration</th></tr></thead>
            <tbody id="tBody"><tr><td colspan="9" style="text-align:center;padding:40px;color:var(--t3)">...</td></tr></tbody></table>
            </div></div>
        </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ SETTINGS SECTION ‚îÄ‚îÄ‚îÄ -->
    <div class="section" id="sec-settings">
        <h2 style="font-size:20px;font-weight:800;margin-bottom:6px">Settings</h2>
        <p style="color:var(--t3);font-size:13px;margin-bottom:28px">Configura tu cuenta de trading</p>

        <div class="settings-grid">
        <div class="setting-card" id="settingBrokerCard">
            <div class="sc-icon" style="background:var(--grn-d);border:1px solid rgba(0,224,135,.15)">üîó</div>
            <div class="setting-status disconnected" id="settingStatus">
            <div class="top-dot off" id="settingDot"></div> Sin conectar
            </div>
            <h3>Cuenta de Broker</h3>
            <p id="settingDesc">Conecta tu MT4/MT5 para habilitar el trading journal con m√©tricas autom√°ticas.</p>
            <button class="setting-btn green" id="settingBtn" onclick="openModal()">Conectar Broker</button>
        </div>
        <div class="setting-card">
            <div class="sc-icon" style="background:var(--blu-d);border:1px solid rgba(77,141,255,.12)">üîî</div>
            <div class="setting-status disconnected"><div class="top-dot off"></div> Pr√≥ximamente</div>
            <h3>Notificaciones</h3>
            <p>Recibe alertas cuando tus m√©tricas cambien o alcances tus objetivos de trading.</p>
            <button class="setting-btn green" disabled style="opacity:.4;cursor:not-allowed">Pr√≥ximamente</button>
        </div>
        </div>
    </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: CONNECT BROKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-bg" id="modalBg" onclick="if(event.target===this)closeModal()">
    <div class="modal">
        <div class="modal-close" onclick="closeModal()">‚úï</div>
        <div class="modal-title">Conectar Broker</div>
        <div class="modal-sub">// datos de tu cuenta MetaTrader</div>

        <div class="fg">
        <label>Servidor <span class="hint">‚Äî como aparece en tu MT5</span></label>
        <input type="text" id="brServer" placeholder="ej: ICMarketsSC-MT5, MetaQuotes-Demo"/>
        </div>
        <div class="frow">
        <div class="fg">
            <label>Login <span class="hint">‚Äî n√∫mero</span></label>
            <input type="text" id="brLogin" placeholder="ej: 12345678" inputmode="numeric"/>
        </div>
        <div class="fg">
            <label>Plataforma</label>
            <select id="brPlatform"><option value="mt5" selected>MetaTrader 5</option><option value="mt4">MetaTrader 4</option></select>
        </div>
        </div>
        <div class="fg">
        <label>Password <span class="hint">‚Äî investor (read-only) recomendado</span></label>
        <input type="password" id="brPass" placeholder="Investor password"/>
        </div>
        <button class="btn-submit" id="brSubmit" onclick="doConnect()">Conectar Cuenta</button>
        <div class="err-msg" id="brErr"></div>
        <div class="info-box">
        <strong>üîí Seguridad</strong><br>
        Tu password se env√≠a cifrada al servidor de conexi√≥n y nunca se guarda en nuestro sistema.
        Usa el <strong>Investor Password</strong> (solo lectura) para m√°xima seguridad.
        </div>
    </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="loader" id="loader"><div class="spin"></div><div class="loader-txt" id="loaderTxt">Conectando...</div></div>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        üîß FIREBASE ‚Äî Reemplaza o quita si ya lo inicializas en tu app
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        if (!firebase.apps.length) {
        firebase.initializeApp({
            apiKey: "AIzaSyAdKShZMYYdmZ3bkmaDWsEhsLsT0YIgz-8",
            authDomain: "dontrading-pro.firebaseapp.com",
            projectId: "dontrading-pro",
            storageBucket: "dontrading-pro.firebasestorage.app",
            messagingSenderId: "684854856085",
            appId: "1:684854856085:web:fd18dc2c46ff13ea81ce9c",
            measurementId: "G-FYNX14F2VY"
        });
        }
        const auth = firebase.auth();
        const fns  = firebase.functions();
        // fns.useEmulator("localhost", 5001);

        const F = {
        connectBroker:    fns.httpsCallable('connectBroker'),
        getUserStatus:    fns.httpsCallable('getUserStatus'),
        getAccountInfo:   fns.httpsCallable('getAccountInfo'),
        getMetrics:       fns.httpsCallable('getMetrics'),
        getTrades:        fns.httpsCallable('getTrades'),
        getDailyGrowth:   fns.httpsCallable('getDailyGrowth'),
        disconnectBroker: fns.httpsCallable('disconnectBroker'),
        };

        let S = { m:null, trades:[], dPnl:[], wPnl:[], mPnl:[], info:null, connected:false };
        const $ = id => document.getElementById(id);

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        AUTH LISTENER ‚Äî detecta si ya est√° logueado
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        auth.onAuthStateChanged(async u => {
        if (!u) return; // Tu app maneja el login
        try {
            const { data } = await F.getUserStatus();
            if (data.connected) {
            setBrokerConnected(data);
            await loadData();
            }
        } catch(e) { console.warn('getUserStatus:', e.message); }
        });

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        UI STATE
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function setBrokerConnected(data) {
        S.connected = true;
        // Topbar
        $('topConnectBtn').style.display = 'none';
        $('topAcctInfo').style.display = 'flex';
        $('topBalance').style.display = 'flex';
        $('topRefresh').style.display = 'inline-flex';
        $('topAcctText').textContent = `${(data.platform||'mt5').toUpperCase()} ‚Ä¢ ${data.mtLogin} @ ${data.brokerServer}`;
        // Journal
        $('emptyState').style.display = 'none';
        $('dashState').style.display = 'block';
        // Settings
        $('settingStatus').className = 'setting-status connected';
        $('settingStatus').innerHTML = '<div class="top-dot on"></div> Conectado';
        $('settingDesc').textContent = `${(data.platform||'mt5').toUpperCase()} ‚Ä¢ ${data.mtLogin} @ ${data.brokerServer}`;
        $('settingBtn').textContent = 'Desconectar';
        $('settingBtn').className = 'setting-btn red';
        $('settingBtn').onclick = doDisconnect;
        }

        function setBrokerDisconnected() {
        S.connected = false;
        S = { m:null, trades:[], dPnl:[], wPnl:[], mPnl:[], info:null, connected:false };
        $('topConnectBtn').style.display = 'inline-flex';
        $('topAcctInfo').style.display = 'none';
        $('topBalance').style.display = 'none';
        $('topRefresh').style.display = 'none';
        $('emptyState').style.display = 'block';
        $('dashState').style.display = 'none';
        $('settingStatus').className = 'setting-status disconnected';
        $('settingStatus').innerHTML = '<div class="top-dot off"></div> Sin conectar';
        $('settingDesc').textContent = 'Conecta tu MT4/MT5 para habilitar el trading journal con m√©tricas autom√°ticas.';
        $('settingBtn').textContent = 'Conectar Broker';
        $('settingBtn').className = 'setting-btn green';
        $('settingBtn').onclick = openModal;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        CONNECT / DISCONNECT
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        async function doConnect() {
        const sv=$('brServer').value.trim(), lg=$('brLogin').value.trim(), pw=$('brPass').value, pl=$('brPlatform').value;
        if (!sv||!lg||!pw) return err('brErr','Completa todos los campos');
        clrErr('brErr');
        $('brSubmit').disabled = true;
        closeModal();
        loading('Conectando con tu broker...\nEsto puede tomar 30-60 segundos');
        try {
            const { data } = await F.connectBroker({ brokerServer:sv, mtLogin:lg, mtPassword:pw, platform:pl });
            if (data.success) {
            if (!data.deployed) { loading('Desplegando servidor...'); await sleep(12000); }
            setBrokerConnected({ brokerServer:sv, mtLogin:lg, platform:pl });
            await loadData();
            }
        } catch(e) {
            hide(); openModal(); err('brErr', e.message || 'Error al conectar. Verifica tus credenciales.');
        } finally { $('brSubmit').disabled = false; }
        }

        async function doDisconnect() {
        if (!confirm('¬øDesconectar tu cuenta de broker? Puedes reconectarla despu√©s.')) return;
        loading('Desconectando...');
        try { await F.disconnectBroker(); } catch(_) {}
        hide();
        setBrokerDisconnected();
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        LOAD DASHBOARD DATA
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        async function loadData() {
        try {
            loading('Obteniendo balance...');
            const i = await F.getAccountInfo(); S.info = i.data;

            loading('Calculando m√©tricas...');
            const mr = await F.getMetrics();
            S.m = mr.data?.ok ? mr.data.metrics : null;

            loading('Cargando trades...');
            const tr = await F.getTrades();
            S.trades = tr.data?.trades || [];

            if (!S.m && S.trades.length > 0) { S.m = calcMetrics(S.trades); $('banner').style.display = 'block'; }

            loading('Analizando P&L...');
            try { const g = await F.getDailyGrowth(); S.dPnl = g.data?.data || []; } catch(_) {}
            if (!S.dPnl.length) S.dPnl = dailyFromTrades(S.trades);
            S.wPnl = aggPnl(S.dPnl,'w'); S.mPnl = aggPnl(S.dPnl,'m');

            hide(); render();
        } catch(e) { hide(); console.error(e); }
        }
        function refresh() { loadData(); }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        RENDER DASHBOARD
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function render() {
        const m=S.m, i=S.info; if (!m) return;
        const cur = i?.currency || 'USD';
        if (i) $('topBalance').textContent = 'Balance: ' + fc(i.balance, cur);

        const pr=m.profit??m.netProfit??0, tt=m.trades??m.totalTrades??0;
        const wr=m.wonTradesPercent??m.winRate??0, pf=m.profitFactor??0;
        const dd=m.maxDrawdown??0, aw=m.averageWin??0, al=m.averageLoss??0;
        const wt=m.wonTrades??0, lt=m.lostTrades??0;
        const lo=m.longTrades??m.buyTrades??0, sh=m.shortTrades??m.sellTrades??0;

        sm('mProfit',fc(pr,cur),pr>=0?'pos':'neg'); $('mProfitS').textContent=cur;
        sm('mTrades',tt,'neu'); $('mTradesS').textContent=wt+'W / '+lt+'L';
        sm('mWR',(wr<1?wr*100:wr).toFixed(1)+'%',wr>=.5?'pos':'neg'); $('mWRS').textContent=wt+' of '+tt;
        sm('mPF',pf===Infinity?'‚àû':pf.toFixed(2),'neu'); $('mPFS').textContent=pf>=1.5?'Healthy':pf>=1?'Marginal':'Negative';
        sm('mDD',fc(-Math.abs(dd),cur),'neg');
        const ar=al!==0?Math.abs(aw/al).toFixed(2):'‚àû';
        $('mAvg').textContent=ar+'R'; $('mAvgS').textContent='W:'+fc(aw,cur)+' / L:'+fc(al,cur);

        const wp=wr<1?wr:wr/100;
        ring('wrArc',wp); $('wrTxt').textContent=(wp*100).toFixed(0)+'%';
        $('rWins').textContent=wt; $('rWinD').textContent=wt+' wins / '+lt+' losses';

        const tls=lo+sh, lp=tls>0?lo/tls:.5;
        ring('lsArc',lp,'#4d8dff'); $('lsTxt').textContent=(lp*100).toFixed(0)+'%';
        $('rLongs').textContent=lo; $('rLongD').textContent=lo+' longs / '+sh+' shorts';

        drawEq(); drawBars('daily'); pnlSum(); renderTable();
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        HELPERS
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function sm(id,v,c){const e=$(id);e.textContent=v;e.className='mv '+c}
        function fc(v,c){const s=c==='EUR'?'‚Ç¨':c==='GBP'?'¬£':'$';return(v>=0?'':'-')+s+Math.abs(v||0).toFixed(2)}
        function fd(d){return d?new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'}):'--'}
        function fdu(ms){if(!ms||ms<0)return'--';const s=ms/1000|0;if(s<60)return s+'s';const m=s/60|0;if(m<60)return m+'m';const h=m/60|0;return h<24?h+'h '+(m%60)+'m':(h/24|0)+'d '+(h%24)+'h'}
        function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
        function ring(id,pct,color){const a=$(id),o=314*(1-Math.max(0,Math.min(1,pct)));if(color)a.setAttribute('stroke',color);setTimeout(()=>{a.style.transition='stroke-dashoffset 1s ease-out';a.setAttribute('stroke-dashoffset',o)},200)}
        function loading(t){$('loader').classList.add('on');$('loaderTxt').textContent=t}
        function hide(){$('loader').classList.remove('on')}
        function err(id,m){const e=$(id);e.textContent=m;e.style.display='block'}
        function clrErr(id){$(id).style.display='none'}

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        NAVIGATION
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function goSection(s){
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('on'));
        document.querySelector('[data-s="'+s+'"]').classList.add('on');
        document.querySelectorAll('.section').forEach(x=>x.classList.remove('on'));
        $('sec-'+s).classList.add('on');
        if(s==='journal'&&S.connected){setTimeout(()=>{const jt=document.querySelector('.j-tab.on')?.dataset.jt;if(jt==='overview')drawEq();if(jt==='pnl')drawBars(document.querySelector('.pb.on')?.dataset.p||'daily')},50)}
        }
        function goJTab(t){
        document.querySelectorAll('.j-tab').forEach(x=>x.classList.remove('on'));
        document.querySelector('[data-jt="'+t+'"]').classList.add('on');
        document.querySelectorAll('.jtp').forEach(x=>x.classList.remove('on'));
        $('jtp-'+t).classList.add('on');
        setTimeout(()=>{if(t==='overview')drawEq();if(t==='pnl')drawBars(document.querySelector('.pb.on')?.dataset.p||'daily')},50);
        }
        function goPeriod(p){document.querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));document.querySelector('[data-p="'+p+'"]').classList.add('on');drawBars(p)}
        function openModal(){$('modalBg').classList.add('on');$('brServer').focus()}
        function closeModal(){$('modalBg').classList.remove('on');clrErr('brErr')}

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        FALLBACK METRICS
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function calcMetrics(trades){
        const cl=trades.filter(t=>(t.profit!==undefined||t.netProfit!==undefined)&&t.type!=='DEAL_TYPE_BALANCE'&&t.type!=='DEAL_TYPE_CREDIT');
        if(!cl.length)return null;
        let tp=0,tl=0,wc=0,lc=0,lo=0,sh=0,cum=0,pk=0,mdd=0;
        cl.forEach(t=>{const p=t.profit??t.netProfit??0;cum+=p;
            if(p>0){tp+=p;wc++}else if(p<0){tl+=Math.abs(p);lc++}
            const y=(t.type||'').toLowerCase();if(y.includes('buy')||y.includes('long'))lo++;else sh++;
            if(cum>pk)pk=cum;const d=pk-cum;if(d>mdd)mdd=d});
        const n=wc+lc;
        return{profit:cum,trades:n,wonTradesPercent:n?wc/n:0,profitFactor:tl>0?tp/tl:(tp>0?Infinity:0),
            maxDrawdown:mdd,averageWin:wc?tp/wc:0,averageLoss:lc?-(tl/lc):0,
            wonTrades:wc,lostTrades:lc,longTrades:lo,shortTrades:sh};
        }
        function dailyFromTrades(trades){
        const by={};trades.forEach(t=>{if(t.type==='DEAL_TYPE_BALANCE'||t.type==='DEAL_TYPE_CREDIT')return;
            const d=(t.closeTime||t.closeTimeStr||t.time||'').slice(0,10);if(!d)return;
            if(!by[d])by[d]=0;by[d]+=t.profit??t.netProfit??0});
        return Object.entries(by).sort(([a],[b])=>a.localeCompare(b)).map(([date,profit])=>({date,profit}));
        }
        function aggPnl(daily,mode){
        if(!daily?.length)return[];const g={};
        daily.forEach(d=>{const dt=new Date(d.date);let k;
            if(mode==='w'){const sw=new Date(dt);sw.setDate(dt.getDate()-dt.getDay());k=sw.toISOString().slice(0,10)}
            else k=d.date.slice(0,7)+'-01';
            if(!g[k])g[k]=0;g[k]+=d.profit??d.pnl??d.gains??0});
        return Object.entries(g).sort(([a],[b])=>a.localeCompare(b)).map(([date,profit])=>({date,profit}));
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        CHARTS
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function drawEq(){
        const cv=$('eqCv');if(!cv)return;const ctx=cv.getContext('2d'),dpr=devicePixelRatio||1;
        cv.width=cv.offsetWidth*dpr;cv.height=cv.offsetHeight*dpr;ctx.scale(dpr,dpr);
        const W=cv.offsetWidth,H=cv.offsetHeight,P={t:20,r:20,b:30,l:70};ctx.clearRect(0,0,W,H);
        const tr=S.trades.filter(t=>(t.closeTime||t.closeTimeStr||t.time)&&t.type!=='DEAL_TYPE_BALANCE'&&t.type!=='DEAL_TYPE_CREDIT')
            .sort((a,b)=>new Date(a.closeTime||a.closeTimeStr||a.time)-new Date(b.closeTime||b.closeTimeStr||b.time));
        if(tr.length<2){ctx.fillStyle='#55586e';ctx.font='13px JetBrains Mono';ctx.textAlign='center';ctx.fillText('Not enough trades',W/2,H/2);return}
        let c=[0];tr.forEach(t=>c.push(c[c.length-1]+(t.profit??t.netProfit??0)));
        const mn=Math.min(...c),mx=Math.max(...c),rng=mx-mn||1,cW=W-P.l-P.r,cH=H-P.t-P.b,xs=cW/(c.length-1);
        ctx.strokeStyle='#1c1d28';ctx.lineWidth=1;
        for(let i=0;i<=5;i++){const y=P.t+(cH/5)*i;ctx.beginPath();ctx.moveTo(P.l,y);ctx.lineTo(W-P.r,y);ctx.stroke();
            ctx.fillStyle='#55586e';ctx.font='10px JetBrains Mono';ctx.textAlign='right';ctx.fillText('$'+(mx-(rng/5)*i).toFixed(0),P.l-8,y+3)}
        if(mn<0&&mx>0){const zy=P.t+(mx/rng)*cH;ctx.strokeStyle='#2c2e48';ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(P.l,zy);ctx.lineTo(W-P.r,zy);ctx.stroke();ctx.setLineDash([])}
        const gr=ctx.createLinearGradient(0,P.t,0,H-P.b);gr.addColorStop(0,'rgba(0,224,135,.12)');gr.addColorStop(1,'rgba(0,224,135,0)');
        ctx.beginPath();c.forEach((v,i)=>{const x=P.l+i*xs,y=P.t+((mx-v)/rng)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
        ctx.lineTo(P.l+(c.length-1)*xs,H-P.b);ctx.lineTo(P.l,H-P.b);ctx.closePath();ctx.fillStyle=gr;ctx.fill();
        ctx.beginPath();c.forEach((v,i)=>{const x=P.l+i*xs,y=P.t+((mx-v)/rng)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
        ctx.strokeStyle='#00e087';ctx.lineWidth=2;ctx.lineJoin='round';ctx.stroke();
        const lx=P.l+(c.length-1)*xs,ly=P.t+((mx-c[c.length-1])/rng)*cH;
        ctx.beginPath();ctx.arc(lx,ly,4,0,Math.PI*2);ctx.fillStyle='#00e087';ctx.fill();
        $('eqBadge').textContent=tr.length+' trades';
        }

        function drawBars(period){
        const cv=$('plCv');if(!cv)return;const ctx=cv.getContext('2d'),dpr=devicePixelRatio||1;
        cv.width=cv.offsetWidth*dpr;cv.height=cv.offsetHeight*dpr;ctx.scale(dpr,dpr);
        const W=cv.offsetWidth,H=cv.offsetHeight,P={t:20,r:20,b:40,l:70};ctx.clearRect(0,0,W,H);
        const data=period==='daily'?S.dPnl:period==='weekly'?S.wPnl:S.mPnl;
        if(!data?.length){ctx.fillStyle='#55586e';ctx.font='13px JetBrains Mono';ctx.textAlign='center';ctx.fillText('No data',W/2,H/2);return}
        const vals=data.map(d=>d.profit??d.pnl??0),maxV=Math.max(...vals.map(Math.abs),1);
        const cW=W-P.l-P.r,cH=H-P.t-P.b,bW=Math.max(2,Math.min(40,(cW/vals.length)*.7)),gap=(cW-bW*vals.length)/(vals.length+1),zY=P.t+cH/2;
        ctx.strokeStyle='#2c2e48';ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(P.l,zY);ctx.lineTo(W-P.r,zY);ctx.stroke();ctx.setLineDash([]);
        ctx.fillStyle='#55586e';ctx.font='10px JetBrains Mono';ctx.textAlign='right';
        ctx.fillText('$'+maxV.toFixed(0),P.l-8,P.t+10);ctx.fillText('$0',P.l-8,zY+3);ctx.fillText('-$'+maxV.toFixed(0),P.l-8,P.t+cH);
        vals.forEach((v,i)=>{const x=P.l+gap+i*(bW+gap),bH=(Math.abs(v)/maxV)*(cH/2),y=v>=0?zY-bH:zY;
            ctx.fillStyle=v>=0?'#00e087':'#ff4466';ctx.globalAlpha=.85;const r=Math.min(3,bW/2);ctx.beginPath();
            if(v>=0){ctx.moveTo(x,y+r);ctx.arcTo(x,y,x+r,y,r);ctx.arcTo(x+bW,y,x+bW,y+r,r);ctx.lineTo(x+bW,y+bH);ctx.lineTo(x,y+bH)}
            else{ctx.moveTo(x,y);ctx.lineTo(x+bW,y);ctx.lineTo(x+bW,y+bH-r);ctx.arcTo(x+bW,y+bH,x+bW-r,y+bH,r);ctx.arcTo(x,y+bH,x,y+bH-r,r)}
            ctx.closePath();ctx.fill();ctx.globalAlpha=1;
            if((data.length<=31||i%Math.ceil(data.length/15)===0)&&data[i].date){ctx.save();ctx.translate(x+bW/2,H-P.b+14);ctx.rotate(-.5);ctx.fillStyle='#55586e';ctx.font='9px JetBrains Mono';ctx.textAlign='center';ctx.fillText(new Date(data[i].date).toLocaleDateString('en',{month:'short',day:'numeric'}),0,0);ctx.restore()}
        });
        }

        function pnlSum(){
        const d=S.dPnl;if(!d?.length)return;const v=d.map(x=>x.profit??x.pnl??0),cur=S.info?.currency||'USD';
        $('bestD').textContent=fc(Math.max(...v),cur);$('worstD').textContent=fc(Math.min(...v),cur);
        const avg=v.reduce((a,b)=>a+b,0)/v.length;const e=$('avgD');e.textContent=fc(avg,cur);e.className='mv '+(avg>=0?'pos':'neg');
        const p=v.filter(x=>x>0).length;$('profD').textContent=p+'/'+d.length+' ('+(p/d.length*100).toFixed(0)+'%)';
        }

        function renderTable(){
        const tb=$('tBody'),cur=S.info?.currency||'USD';
        const tr=S.trades.filter(t=>(t.closeTime||t.closeTimeStr||t.time)&&t.type!=='DEAL_TYPE_BALANCE'&&t.type!=='DEAL_TYPE_CREDIT')
            .sort((a,b)=>new Date(b.closeTime||b.closeTimeStr||b.time)-new Date(a.closeTime||a.closeTimeStr||a.time));
        $('tCnt').textContent=tr.length+' trades';
        if(!tr.length){tb.innerHTML='<tr><td colspan="9" style="text-align:center;padding:50px;color:var(--t3)">No trades</td></tr>';return}
        tb.innerHTML=tr.map(t=>{
            const p=t.profit??t.netProfit??0,ty=(t.type||'').toLowerCase(),buy=ty.includes('buy')||ty.includes('long'),
            tp=buy?'buy':'sell',vol=t.volume??t.lots??'--',op=t.openPrice??'--',cp=t.closePrice??'--',
            pips=t.pips??t.gain??'--',ct=t.closeTime||t.closeTimeStr||t.time||'',ot=t.openTime||t.openTimeStr||'',
            dur=ot&&ct?fdu(new Date(ct)-new Date(ot)):'--';
            return '<tr><td>'+fd(ct)+'</td><td style="color:var(--t1);font-weight:500">'+(t.symbol||'--')+'</td><td><span class="ttype '+tp+'">'+tp.toUpperCase()+'</span></td><td>'+(typeof vol==='number'?vol.toFixed(2):vol)+'</td><td>'+(typeof op==='number'?op.toFixed(5):op)+'</td><td>'+(typeof cp==='number'?cp.toFixed(5):cp)+'</td><td class="'+(p>=0?'pos':'neg')+'" style="font-weight:600">'+(p>=0?'+':'')+fc(p,cur)+'</td><td>'+(typeof pips==='number'?pips.toFixed(1):pips)+'</td><td>'+dur+'</td></tr>';
        }).join('');
        }

        /* Resize handler */
        window.addEventListener('resize',()=>{
        if(!S.connected)return;
        const jt=document.querySelector('.j-tab.on')?.dataset.jt;
        if(jt==='overview')drawEq();if(jt==='pnl')drawBars(document.querySelector('.pb.on')?.dataset.p||'daily');
        });
    </script>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DONTRADING - Access</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /*             DONTRADING LOGIN v2.1 â€” Multi-Provider Auth              */
        /*   âœ… Google popup + redirect fallback                                */
        /*   âœ… Email verification on register                                  */
        /*   âœ… Detailed error logging                                          */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-primary: #0a0e17;
            --bg-card: #111827;
            --bg-input: #0d1220;
            --bg-hover: #151d2e;
            --accent: #f59e0b;
            --accent-soft: #d97706;
            --accent-glow: rgba(245, 158, 11, 0.15);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #1e293b;
            --border-light: #334155;
            --positive: #22c55e;
            --negative: #ef4444;
            --info: #3b82f6;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            position: relative;
        }

        /* â”€â”€ BACKGROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background:
                radial-gradient(ellipse 600px 400px at 20% 30%, rgba(245, 158, 11, 0.04) 0%, transparent 70%),
                radial-gradient(ellipse 500px 500px at 80% 70%, rgba(59, 130, 246, 0.03) 0%, transparent 70%),
                radial-gradient(ellipse 400px 300px at 50% 50%, rgba(245, 158, 11, 0.02) 0%, transparent 70%);
            animation: bgDrift 20s ease-in-out infinite alternate;
            pointer-events: none; z-index: 0;
        }
        @keyframes bgDrift {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(30px, -20px) rotate(2deg); }
        }
        body::after {
            content: '';
            position: fixed; inset: 0;
            background-image:
                linear-gradient(rgba(245, 158, 11, 0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(245, 158, 11, 0.015) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none; z-index: 0;
        }

        /* â”€â”€ CONTAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .login-wrapper {
            position: relative; z-index: 1;
            width: 100%; max-width: 440px; padding: 20px;
        }

        /* â”€â”€ LOGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .logo-section { text-align: center; margin-bottom: 32px; }
        .logo-badge {
            display: inline-flex; align-items: center; justify-content: center;
            width: 64px; height: 64px; border-radius: 18px;
            background: linear-gradient(135deg, var(--accent), var(--accent-soft));
            font-weight: 800; font-size: 22px; color: var(--bg-primary);
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(245, 158, 11, 0.2);
            position: relative;
        }
        .logo-badge::after {
            content: ''; position: absolute; inset: -3px; border-radius: 20px;
            background: linear-gradient(135deg, var(--accent), transparent, var(--accent-soft));
            z-index: -1; opacity: 0.3; filter: blur(8px);
        }
        .logo-title { font-size: 26px; font-weight: 300; letter-spacing: -0.5px; }
        .logo-title .brand { font-weight: 800; }
        .logo-title .pro { font-style: italic; font-weight: 300; color: var(--accent); }

        /* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .auth-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; padding: 32px;
            position: relative; overflow: hidden;
        }
        .auth-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0.4;
        }

        /* â”€â”€ VIEW SWITCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .view-switcher {
            display: flex; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 10px;
            padding: 3px; margin-bottom: 24px;
        }
        .switch-btn {
            flex: 1; padding: 10px 0; text-align: center;
            font-size: 13px; font-weight: 600; color: var(--text-muted);
            background: transparent; border: none; border-radius: 8px;
            cursor: pointer; transition: all 0.25s ease; letter-spacing: 0.3px;
        }
        .switch-btn.active { color: var(--bg-primary); background: var(--accent); }

        /* â”€â”€ GOOGLE BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-google {
            width: 100%; height: 48px;
            border: 1px solid var(--border-light); border-radius: 10px;
            background: var(--bg-input); color: var(--text-primary);
            font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 20px;
        }
        .btn-google:hover {
            background: var(--bg-hover);
            box-shadow: 0 2px 12px rgba(66, 133, 244, 0.1);
        }
        .btn-google:disabled { opacity: 0.5; cursor: wait; }
        .btn-google svg { flex-shrink: 0; }

        /* â”€â”€ DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .divider {
            display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
        }
        .divider-line { flex: 1; height: 1px; background: var(--border); }
        .divider-text {
            font-size: 11px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; white-space: nowrap;
        }

        /* â”€â”€ METHOD TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .method-tabs { display: flex; gap: 6px; margin-bottom: 20px; }
        .method-tab {
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
            padding: 9px 12px; background: transparent;
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--text-muted); font-family: 'Outfit', sans-serif;
            font-size: 12.5px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;
        }
        .method-tab:hover { border-color: var(--border-light); color: var(--text-secondary); }
        .method-tab.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
        .method-tab svg { width: 15px; height: 15px; stroke: currentColor; stroke-width: 2; fill: none; }

        /* â”€â”€ PANELS & VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .method-panel { display: none; }
        .method-panel.active { display: block; animation: fadeSlide 0.25s ease; }
        .form-view { display: none; }
        .form-view.active { display: block; animation: fadeSlide 0.3s ease; }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block; font-size: 12px; font-weight: 500;
            color: var(--text-secondary); margin-bottom: 6px;
            letter-spacing: 0.3px; text-transform: uppercase;
        }
        .input-wrapper {
            display: flex; align-items: center; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 10px;
            padding: 0 14px; height: 48px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        .input-icon {
            width: 18px; height: 18px; stroke: var(--text-muted);
            stroke-width: 1.8; fill: none; flex-shrink: 0; margin-right: 10px;
        }
        .input-wrapper:focus-within .input-icon { stroke: var(--accent); }
        .form-input {
            flex: 1; background: transparent; border: none; outline: none;
            color: var(--text-primary); font-family: 'Outfit', sans-serif;
            font-size: 14px; height: 100%;
        }
        .form-input::placeholder { color: var(--text-muted); }
        .phone-prefix {
            font-family: 'JetBrains Mono', monospace; font-size: 13px;
            color: var(--text-secondary); margin-right: 6px; padding-right: 8px;
            border-right: 1px solid var(--border); user-select: none; flex-shrink: 0;
        }
        .password-toggle {
            background: none; border: none; cursor: pointer; padding: 4px;
            display: flex; align-items: center;
        }
        .password-toggle svg {
            width: 18px; height: 18px; stroke: var(--text-muted);
            stroke-width: 1.8; fill: none;
        }
        .password-toggle:hover svg { stroke: var(--text-secondary); }

        /* â”€â”€ OTP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .verify-section {
            display: none; margin-top: 16px; padding: 18px;
            background: rgba(245, 158, 11, 0.04);
            border: 1px solid rgba(245, 158, 11, 0.12); border-radius: 10px;
        }
        .verify-section.active { display: block; animation: fadeSlide 0.3s ease; }
        .otp-input-group { display: flex; gap: 8px; justify-content: center; margin: 14px 0; }
        .otp-digit {
            width: 44px; height: 52px; text-align: center;
            font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600;
            color: var(--text-primary); background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 8px; outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .otp-digit:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .verify-label { text-align: center; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .verify-phone-display {
            text-align: center; font-family: 'JetBrains Mono', monospace;
            font-size: 14px; color: var(--accent); font-weight: 500;
        }
        .resend-link {
            display: block; text-align: center; font-size: 12px;
            color: var(--text-muted); margin-top: 10px; cursor: pointer; transition: color 0.2s;
        }
        .resend-link:hover { color: var(--accent); }

        /* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-primary {
            width: 100%; height: 48px; border: none; border-radius: 10px;
            background: linear-gradient(135deg, var(--accent), var(--accent-soft));
            color: var(--bg-primary); font-family: 'Outfit', sans-serif;
            font-size: 14px; font-weight: 700; letter-spacing: 0.8px;
            text-transform: uppercase; cursor: pointer; transition: all 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.25);
        }
        .btn-primary:active:not(:disabled) { transform: translateY(0); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-spinner {
            display: inline-block; width: 18px; height: 18px;
            border: 2px solid transparent; border-top-color: var(--bg-primary);
            border-radius: 50%; animation: spin 0.6s linear infinite;
            vertical-align: middle; margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ ALERT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .alert {
            display: none; padding: 12px 14px; border-radius: 8px;
            font-size: 13px; margin-bottom: 18px;
            align-items: flex-start; gap: 8px; line-height: 1.4;
        }
        .alert.show { display: flex; animation: fadeSlide 0.3s ease; }
        .alert-icon { flex-shrink: 0; margin-top: 1px; }
        .alert.error {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2); color: #fca5a5;
        }
        .alert.success {
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.2); color: #86efac;
        }
        .alert.info {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.2); color: #93c5fd;
        }

        /* â”€â”€ LINKS & FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .form-link {
            font-size: 12px; color: var(--accent); cursor: pointer;
            text-decoration: none; transition: color 0.2s; font-weight: 500;
        }
        .form-link:hover { color: var(--accent-soft); text-decoration: underline; }
        .form-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        .bottom-text { text-align: center; margin-top: 24px; font-size: 12px; color: var(--text-muted); }

        /* â”€â”€ DEBUG BANNER (removable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .debug-banner {
            display: none; padding: 8px 12px; margin-bottom: 12px;
            background: rgba(59, 130, 246, 0.06); border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 8px; font-size: 11px; color: var(--info);
            font-family: 'JetBrains Mono', monospace; word-break: break-all;
        }
        .debug-banner.show { display: block; }

        /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 480px) {
            .auth-card { padding: 24px 20px; }
            .otp-digit { width: 38px; height: 46px; font-size: 18px; }
            .method-tab { font-size: 11.5px; padding: 8px 8px; }
        }
    </style>
</head>
<body>
    <div class="login-wrapper">

        <!-- LOGO -->
        <div class="logo-section">
            <div class="logo-badge">DT</div>
            <div class="logo-title"><span class="brand">DONTRADING</span> <span class="pro">Pro</span></div>
        </div>

        <!-- AUTH CARD -->
        <div class="auth-card">

            <!-- Debug banner â€” muestra errores detallados, quitar en producciÃ³n -->
            <div class="debug-banner" id="debugBanner"></div>

            <!-- Alert -->
            <div class="alert" id="alertBox">
                <span class="alert-icon" id="alertIcon"></span>
                <span id="alertText"></span>
            </div>

            <!-- Switcher -->
            <div class="view-switcher" id="viewSwitcher">
                <button class="switch-btn active" data-view="login">Iniciar SesiÃ³n</button>
                <button class="switch-btn" data-view="register">Registrarse</button>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- VIEW: LOGIN                                                   -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="form-view active" id="view-login">

                <!-- Google -->
                <button class="btn-google" id="btnGoogleLogin" onclick="handleGoogleSignIn()">
                    <svg width="20" height="20" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    </svg>
                    Continuar con Google
                </button>

                <div class="divider">
                    <div class="divider-line"></div>
                    <span class="divider-text">o ingresa con</span>
                    <div class="divider-line"></div>
                </div>

                <!-- Method tabs -->
                <div class="method-tabs">
                    <button class="method-tab active" data-method="email" data-context="login" onclick="switchMethod('login','email')">
                        <svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                        Email
                    </button>
                    <button class="method-tab" data-method="phone" data-context="login" onclick="switchMethod('login','phone')">
                        <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
                        TelÃ©fono
                    </button>
                </div>

                <!-- Login Email Panel -->
                <div class="method-panel active" id="login-email-panel">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                            <input type="email" class="form-input" id="loginEmail" placeholder="tu@email.com" autocomplete="email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ContraseÃ±a</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            <input type="password" class="form-input" id="loginEmailPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
                            <button class="password-toggle" type="button" tabindex="-1" onclick="togglePassword('loginEmailPassword',this)">
                                <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                        </div>
                    </div>
                    <button class="btn-primary" id="btnLoginEmail" onclick="handleLoginEmail()">INICIAR SESIÃ“N</button>
                    <div class="form-footer">
                        <span class="form-link" onclick="showView('recovery')">Â¿Olvidaste tu contraseÃ±a?</span>
                    </div>
                </div>

                <!-- Login Phone Panel -->
                <div class="method-panel" id="login-phone-panel">
                    <div class="form-group">
                        <label class="form-label">TelÃ©fono</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
                            <span class="phone-prefix">+1</span>
                            <input type="tel" class="form-input" id="loginPhone" placeholder="(555) 123-4567" maxlength="14" autocomplete="tel">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ContraseÃ±a</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            <input type="password" class="form-input" id="loginPhonePassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
                            <button class="password-toggle" type="button" tabindex="-1" onclick="togglePassword('loginPhonePassword',this)">
                                <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                        </div>
                    </div>

                    <!-- OTP Login -->
                    <div class="verify-section" id="loginPhoneVerify">
                        <p class="verify-label">CÃ³digo enviado a</p>
                        <p class="verify-phone-display" id="loginVerifyPhone"></p>
                        <div class="otp-input-group" id="loginOtpGroup">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                        </div>
                        <button class="btn-primary" id="btnVerifyLogin" onclick="verifyLoginOTP()">VERIFICAR CÃ“DIGO</button>
                        <span class="resend-link" onclick="resendLoginCode()">Reenviar cÃ³digo</span>
                    </div>

                    <button class="btn-primary" id="btnLoginPhone" onclick="handleLoginPhone()">INICIAR SESIÃ“N</button>
                    <div class="form-footer">
                        <span class="form-link" onclick="showView('recovery')">Â¿Olvidaste tu contraseÃ±a?</span>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- VIEW: REGISTER                                                -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="form-view" id="view-register">

                <!-- Google -->
                <button class="btn-google" onclick="handleGoogleSignIn()">
                    <svg width="20" height="20" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    </svg>
                    Registrarse con Google
                </button>

                <div class="divider">
                    <div class="divider-line"></div>
                    <span class="divider-text">o regÃ­strate con</span>
                    <div class="divider-line"></div>
                </div>

                <!-- Method tabs -->
                <div class="method-tabs">
                    <button class="method-tab active" data-method="email" data-context="register" onclick="switchMethod('register','email')">
                        <svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                        Email
                    </button>
                    <button class="method-tab" data-method="phone" data-context="register" onclick="switchMethod('register','phone')">
                        <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
                        TelÃ©fono
                    </button>
                </div>

                <!-- Register Email Panel -->
                <div class="method-panel active" id="register-email-panel">
                    <div class="form-group">
                        <label class="form-label">Nombre completo</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <input type="text" class="form-input" id="regEmailName" placeholder="Tu nombre" autocomplete="name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                            <input type="email" class="form-input" id="regEmail" placeholder="tu@email.com" autocomplete="email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ContraseÃ±a</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            <input type="password" class="form-input" id="regEmailPassword" placeholder="MÃ­nimo 6 caracteres" autocomplete="new-password">
                            <button class="password-toggle" type="button" tabindex="-1" onclick="togglePassword('regEmailPassword',this)">
                                <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">TelÃ©fono <span style="color:var(--text-muted);text-transform:none;font-weight:400">(opcional)</span></label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
                            <span class="phone-prefix">+1</span>
                            <input type="tel" class="form-input" id="regEmailPhone" placeholder="(555) 123-4567" maxlength="14" autocomplete="tel">
                        </div>
                    </div>
                    <button class="btn-primary" id="btnRegisterEmail" onclick="handleRegisterEmail()">CREAR CUENTA</button>
                </div>

                <!-- Register Phone Panel -->
                <div class="method-panel" id="register-phone-panel">
                    <div class="form-group">
                        <label class="form-label">Nombre completo</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <input type="text" class="form-input" id="regPhoneName" placeholder="Tu nombre" autocomplete="name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">TelÃ©fono</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
                            <span class="phone-prefix">+1</span>
                            <input type="tel" class="form-input" id="regPhone" placeholder="(555) 123-4567" maxlength="14" autocomplete="tel">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ContraseÃ±a</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                            <input type="password" class="form-input" id="regPhonePassword" placeholder="MÃ­nimo 6 caracteres" autocomplete="new-password">
                            <button class="password-toggle" type="button" tabindex="-1" onclick="togglePassword('regPhonePassword',this)">
                                <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span style="color:var(--text-muted);text-transform:none;font-weight:400">(opcional - recuperaciÃ³n)</span></label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                            <input type="email" class="form-input" id="regPhoneEmail" placeholder="tu@email.com" autocomplete="email">
                        </div>
                    </div>

                    <!-- OTP Register -->
                    <div class="verify-section" id="registerPhoneVerify">
                        <p class="verify-label">Verifica tu nÃºmero</p>
                        <p class="verify-phone-display" id="regVerifyPhone"></p>
                        <div class="otp-input-group" id="regOtpGroup">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                            <input type="text" class="otp-digit" maxlength="1" inputmode="numeric">
                        </div>
                        <button class="btn-primary" id="btnVerifyRegister" onclick="verifyRegisterOTP()">VERIFICAR Y CREAR CUENTA</button>
                        <span class="resend-link" onclick="resendRegisterCode()">Reenviar cÃ³digo</span>
                    </div>

                    <button class="btn-primary" id="btnRegisterPhone" onclick="handleRegisterPhone()">ENVIAR CÃ“DIGO DE VERIFICACIÃ“N</button>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- VIEW: RECOVERY                                                -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="form-view" id="view-recovery">
                <div style="text-align:center; margin-bottom: 20px;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round"><path d="M12 2a10 10 0 00-6.88 17.23l-.82 2.46a1 1 0 001.26 1.26l2.46-.82A10 10 0 1012 2z"/><path d="M12 8v4"/><circle cx="12" cy="16" r="0.5"/></svg>
                    <p style="font-size:14px;color:var(--text-secondary);margin-top:10px;">Enviaremos instrucciones a tu email registrado</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Email de recuperaciÃ³n</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                        <input type="email" class="form-input" id="recoveryEmail" placeholder="tu@email.com" autocomplete="email">
                    </div>
                </div>
                <button class="btn-primary" id="btnRecovery" onclick="handleRecovery()">ENVIAR ENLACE DE RECUPERACIÃ“N</button>
                <div style="margin-top:16px;text-align:center;">
                    <span class="form-link" onclick="showView('login')">â† Volver al inicio de sesiÃ³n</span>
                </div>
            </div>

        </div>

        <div class="bottom-text">
            DONTRADING &copy; 2026 &middot; Todos los derechos reservados
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- FIREBASE SDK                                                          -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- CODE LOGIC                                                          -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DONTRADING â€” AUTH MODULE v3.0 â€” ONBOARDING EDITION
        // âœ… Google: popup con fallback a redirect + auto-perfil en "usuarios"
        // âœ… Email: registro + verificaciÃ³n obligatoria + onboarding
        // âœ… Phone: OTP con reCAPTCHA invisible + onboarding
        // âœ… Debug: banner visual + logs detallados
        // âœ… Redirect: getRedirectResult() al cargar pÃ¡gina
        // âœ… Widget de verificaciÃ³n de email post-registro
        // âœ… NEW: Onboarding â€” verifica colecciÃ³n "usuarios" antes de redirigir
        // âœ… NEW: Google auto-crea perfil, Email/Phone â†’ completar-perfil.html
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â”€â”€â”€ FIREBASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var firebaseConfig = {
            apiKey: "AIzaSyAdKShZMYYdmZ3bkmaDWsEhsLsT0YIgz-8",
            authDomain: "dontrading-pro.firebaseapp.com",
            projectId: "dontrading-pro",
            storageBucket: "dontrading-pro.firebasestorage.app",
            messagingSenderId: "684854856085",
            appId: "1:684854856085:web:fd18dc2c46ff13ea81ce9c",
            measurementId: "G-FYNX14F2VY"
        };

        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();
        var db   = firebase.firestore();
        auth.languageCode = 'es';

        // â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var confirmationResultLogin    = null;
        var confirmationResultRegister = null;
        var recaptchaVerifierLogin     = null;
        var recaptchaVerifierRegister  = null;
        var pendingRegPhoneData        = {};
        var isRedirecting              = false;
        var isWaitingEmailVerification = false;  // â† NUEVO: bloquea auto-redirect mientras espera verificaciÃ³n

        // â”€â”€â”€ Google Provider â€” configuraciÃ³n completa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('email');
        googleProvider.addScope('profile');
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DEBUG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        var DEBUG_MODE = true;

        function debugLog(msg, data) {
            console.log('ğŸ” ' + msg, data || '');
            if (DEBUG_MODE) {
                var banner = document.getElementById('debugBanner');
                banner.classList.add('show');
                banner.textContent = msg + (data ? ' â†’ ' + JSON.stringify(data) : '');
            }
        }

        function debugError(msg, err) {
            console.error('âŒ ' + msg, err);
            if (DEBUG_MODE) {
                var banner = document.getElementById('debugBanner');
                banner.classList.add('show');
                banner.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                banner.style.color = '#fca5a5';
                banner.textContent = msg + ' â†’ code: ' + (err.code || 'N/A') + ' | msg: ' + (err.message || err);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // getRedirectResult â€” Google Redirect
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        (async function checkRedirectResult() {
            try {
                debugLog('Checking getRedirectResult...');
                var result = await auth.getRedirectResult();

                if (result && result.user) {
                    debugLog('âœ… Redirect result captured! UID: ' + result.user.uid);
                    isRedirecting = true;
                    await saveUserToFirestore(result.user, { provider: 'google' });
                    showAlert('success', 'Â¡Bienvenido! Verificando perfil...');
                    await checkProfileAndRedirect(result.user, 'google', 1200);
                } else {
                    debugLog('No redirect result (normal page load)');
                }
            } catch (err) {
                debugError('getRedirectResult error', err);
                if (err.code === 'auth/account-exists-with-different-credential') {
                    showAlert('error', 'Ya existe una cuenta con ese email usando otro mÃ©todo (telÃ©fono o email). Inicia sesiÃ³n con el mÃ©todo original.');
                }
            }
        })();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VIEW / TAB MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showView(viewName) {
            document.querySelectorAll('.form-view').forEach(function(v) { v.classList.remove('active'); });
            var target = document.getElementById('view-' + viewName);
            if (target) target.classList.add('active');
            document.querySelectorAll('.switch-btn').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.getAttribute('data-view') === viewName) btn.classList.add('active');
            });
            document.getElementById('viewSwitcher').style.display = viewName === 'recovery' ? 'none' : 'flex';

            // â”€â”€ Ocultar widget de verificaciÃ³n si cambia de vista â”€â”€
            hideEmailVerificationWidget();
            hideAlert();
        }

        document.querySelectorAll('.switch-btn').forEach(function(btn) {
            btn.addEventListener('click', function() { showView(btn.getAttribute('data-view')); });
        });

        function switchMethod(context, method) {
            document.querySelectorAll('.method-tab[data-context="' + context + '"]').forEach(function(tab) {
                tab.classList.toggle('active', tab.getAttribute('data-method') === method);
            });
            var emailPanel = document.getElementById(context + '-email-panel');
            var phonePanel = document.getElementById(context + '-phone-panel');
            if (emailPanel) emailPanel.classList.toggle('active', method === 'email');
            if (phonePanel) phonePanel.classList.toggle('active', method === 'phone');
            hideAlert();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ALERTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showAlert(type, message) {
            var box = document.getElementById('alertBox');
            box.className = 'alert show ' + type;
            document.getElementById('alertText').textContent = message;
            document.getElementById('alertIcon').textContent = { error:'âš ï¸', success:'âœ…', info:'â„¹ï¸' }[type] || '';
        }
        function hideAlert() { document.getElementById('alertBox').className = 'alert'; }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // REDIRECT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function redirectToDashboard(delay) {
            delay = delay || 1200;
            isRedirecting = true;
            console.log('ğŸš€ Redirect en ' + delay + 'ms');
            setTimeout(function() { window.location.href = 'dashboard.html'; }, delay);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  ONBOARDING â€” Verifica perfil en colecciÃ³n "usuarios" antes de redirigir
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        /**
         * Flujo:
         *   1) Busca doc en "usuarios/{uid}"
         *   2) Si existe y tiene username â†’ dashboard.html
         *   3) Si NO existe y provider es 'google' â†’ crea perfil auto â†’ dashboard.html
         *   4) Si NO existe y provider es 'email'|'phone' â†’ completar-perfil.html
         *
         * Estructura "usuarios":
         *   uid, username, displayUsername, email, phone,
         *   avatarUrl, tipoRegistro, fechaCreacion
         */
        async function checkProfileAndRedirect(user, provider, delay) {
            delay = delay || 1200;
            isRedirecting = true;

            console.log('ğŸ” [ONBOARDING] Verificando perfil en "usuarios" | UID:', user.uid, '| Provider:', provider);

            try {
                var docRef = db.collection('usuarios').doc(user.uid);
                var docSnap = await docRef.get();

                if (docSnap.exists && docSnap.data().username) {
                    // â”€â”€ âœ… Perfil completo â†’ Dashboard â”€â”€
                    console.log('âœ… [ONBOARDING] Perfil encontrado. Username:', docSnap.data().username);
                    showAlert('success', 'Â¡Bienvenido de vuelta, ' + (docSnap.data().displayUsername || docSnap.data().username) + '!');
                    setTimeout(function() { window.location.href = 'dashboard.html'; }, delay);

                } else if (provider === 'google') {
                    // â”€â”€ ğŸ”µ Google nuevo â†’ Crear perfil automÃ¡tico â†’ Dashboard â”€â”€
                    console.log('ğŸ”µ [ONBOARDING] Google: creando perfil automÃ¡tico...');

                    var autoUsername = (user.displayName || 'trader')
                        .toLowerCase()
                        .replace(/\s+/g, '_')
                        .replace(/[^a-z0-9_]/g, '')
                        .substring(0, 20);

                    // Verificar duplicado de username
                    var usernameCheck = await db.collection('usuarios')
                        .where('username', '==', autoUsername)
                        .limit(1).get();

                    if (!usernameCheck.empty) {
                        autoUsername = autoUsername.substring(0, 14) + '_' + Math.floor(Math.random() * 99999);
                    }

                    var profileData = {
                        uid:            user.uid,
                        username:       autoUsername,
                        displayUsername: user.displayName || autoUsername,
                        email:          user.email || '',
                        phone:          user.phoneNumber || '',
                        avatarUrl:      user.photoURL || 'ğŸ‚',
                        tipoRegistro:   'google',
                        fechaCreacion:  firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await docRef.set(profileData);
                    console.log('âœ… [ONBOARDING] Perfil Google creado automÃ¡ticamente:', profileData);

                    showAlert('success', 'Â¡Bienvenido a DonTrading! Redirigiendo...');
                    setTimeout(function() { window.location.href = 'dashboard.html'; }, delay);

                } else {
                    // â”€â”€ ğŸ“ Email/Phone nuevo â†’ Completar perfil â”€â”€
                    console.log('ğŸ“ [ONBOARDING] Sin perfil completo. Redirigiendo a completar-perfil.html...');
                    showAlert('info', 'Completa tu perfil para continuar...');
                    setTimeout(function() { window.location.href = 'completar-perfil.html'; }, delay);
                }

            } catch (err) {
                console.error('âŒ [ONBOARDING] Error al verificar perfil:', err);
                // Fallback: si falla Firestore, mandar a completar perfil para no perder al usuario
                console.warn('âš ï¸ [ONBOARDING] Fallback â†’ completar-perfil.html');
                setTimeout(function() { window.location.href = 'completar-perfil.html'; }, delay);
            }
        }

        /**
         * Detecta el provider del usuario autenticado.
         * @returns {string} 'google' | 'email' | 'phone'
         */
        function detectProvider(user) {
            if (!user || !user.providerData) return 'email';
            var providers = user.providerData.map(function(p) { return p.providerId; });
            if (providers.indexOf('google.com') !== -1) return 'google';
            if (providers.indexOf('phone') !== -1) return 'phone';
            return 'email';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FIRESTORE HELPER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function saveUserToFirestore(user, extraData) {
            extraData = extraData || {};
            try {
                var docRef = db.collection('users').doc(user.uid);
                var doc = await docRef.get();

                if (!doc.exists) {
                    await docRef.set({
                        name:      extraData.name || user.displayName || '',
                        email:     extraData.email || user.email || '',
                        phone:     extraData.phone || user.phoneNumber || '',
                        uid:       user.uid,
                        photoURL:  user.photoURL || '',
                        provider:  extraData.provider || 'unknown',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        plan:      'free',
                        verified:  false  // â† CAMBIO: empieza como false hasta verificar email
                    });
                    debugLog('âœ… Nuevo usuario en Firestore (verified: false)');
                } else {
                    var update = { lastLogin: firebase.firestore.FieldValue.serverTimestamp() };
                    var existing = doc.data();
                    if (!existing.email && (extraData.email || user.email)) update.email = extraData.email || user.email;
                    if (!existing.phone && (extraData.phone || user.phoneNumber)) update.phone = extraData.phone || user.phoneNumber;
                    if (!existing.name && (extraData.name || user.displayName)) update.name = extraData.name || user.displayName;
                    if (!existing.photoURL && user.photoURL) update.photoURL = user.photoURL;
                    await docRef.update(update);
                    debugLog('âœ… Usuario actualizado en Firestore');
                }
            } catch (err) {
                debugError('Firestore save (no bloquea redirect)', err);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILITIES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function cleanPhoneNumber(phone) {
            var digits = phone.replace(/\D/g, '');
            if (digits.length > 10) return '+' + digits;
            return '+1' + digits;
        }
        function formatPhoneInput(input) {
            var d = input.value.replace(/\D/g, '');
            if (d.length >= 7) input.value = '(' + d.substring(0,3) + ') ' + d.substring(3,6) + '-' + d.substring(6,10);
            else if (d.length >= 4) input.value = '(' + d.substring(0,3) + ') ' + d.substring(3);
            else if (d.length > 0) input.value = '(' + d;
        }
        ['loginPhone','regPhone','regEmailPhone'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.addEventListener('input', function() { formatPhoneInput(el); });
        });
        function togglePassword(inputId, btn) {
            var input = document.getElementById(inputId);
            var isPass = input.type === 'password';
            input.type = isPass ? 'text' : 'password';
            btn.innerHTML = isPass
                ? '<svg viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19M1 1l22 22"/></svg>'
                : '<svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>';
        }
        function setButtonLoading(btnId, loading) {
            var btn = document.getElementById(btnId);
            if (!btn) return;
            if (loading) {
                btn.disabled = true;
                btn.setAttribute('data-original-text', btn.textContent);
                btn.innerHTML = '<span class="btn-spinner"></span>Procesando...';
            } else {
                btn.disabled = false;
                btn.textContent = btn.getAttribute('data-original-text') || 'Enviar';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OTP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setupOTPInputs(groupId) {
            var inputs = document.querySelectorAll('#' + groupId + ' .otp-digit');
            inputs.forEach(function(input, i) {
                input.addEventListener('input', function(e) {
                    var v = e.target.value.replace(/\D/g, '');
                    e.target.value = v.charAt(0) || '';
                    if (v && i < inputs.length - 1) inputs[i + 1].focus();
                });
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !e.target.value && i > 0) inputs[i - 1].focus();
                });
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    var pd = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '');
                    for (var j = 0; j < inputs.length && j < pd.length; j++) inputs[j].value = pd.charAt(j);
                    inputs[Math.min(pd.length, inputs.length - 1)].focus();
                });
            });
        }
        function getOTPValue(groupId) {
            var c = ''; document.querySelectorAll('#' + groupId + ' .otp-digit').forEach(function(i) { c += i.value; }); return c;
        }
        function clearOTP(groupId) {
            document.querySelectorAll('#' + groupId + ' .otp-digit').forEach(function(i) { i.value = ''; });
        }
        setupOTPInputs('loginOtpGroup');
        setupOTPInputs('regOtpGroup');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RECAPTCHA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setupRecaptchaInvisible(buttonId) {
            return new firebase.auth.RecaptchaVerifier(buttonId, {
                'size': 'invisible',
                'callback': function() { debugLog('reCAPTCHA OK: ' + buttonId); },
                'expired-callback': function() { debugLog('reCAPTCHA expired'); }
            });
        }
        function safeResetRecaptcha(v) {
            try { if (v) v.clear(); } catch(e) { /* silent */ }
            return null;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  WIDGET DE VERIFICACIÃ“N DE EMAIL â€” NUEVO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /**
         * Inyecta el widget HTML si no existe aÃºn en el DOM.
         * Se llama una sola vez; las siguientes llamadas solo muestran/ocultan.
         */
        function ensureVerificationWidgetExists() {
            if (document.getElementById('emailVerificationWidget')) return;

            var widget = document.createElement('div');
            widget.id = 'emailVerificationWidget';
            widget.innerHTML = ''
                + '<div class="evw-overlay" id="evwOverlay"></div>'
                + '<div class="evw-card">'
                +   '<div class="evw-icon">ğŸ“§</div>'
                +   '<h2 class="evw-title">Verifica tu correo electrÃ³nico</h2>'
                +   '<p class="evw-text">Hemos enviado un enlace de verificaciÃ³n a:</p>'
                +   '<p class="evw-email" id="evwEmail">â€”</p>'
                +   '<p class="evw-text evw-sub">Revisa tu bandeja de entrada y carpeta de spam. Haz clic en el enlace del correo y luego regresa aquÃ­.</p>'
                +   '<button class="evw-btn evw-btn-primary" id="btnCheckVerified" onclick="checkEmailVerified()">'
                +     'âœ… Ya verifiquÃ© mi correo'
                +   '</button>'
                +   '<button class="evw-btn evw-btn-secondary" id="btnResendVerification" onclick="resendVerificationEmail()">'
                +     'ğŸ”„ Reenviar correo de verificaciÃ³n'
                +   '</button>'
                +   '<p class="evw-status" id="evwStatus"></p>'
                +   '<a href="#" class="evw-link" onclick="cancelVerificationAndLogout(); return false;">â† Volver al inicio de sesiÃ³n</a>'
                + '</div>';

            // â”€â”€ Estilos del widget â”€â”€
            var style = document.createElement('style');
            style.textContent = ''
                + '#emailVerificationWidget { display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; }'
                + '#emailVerificationWidget.active { display:flex; align-items:center; justify-content:center; }'
                + '.evw-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter:blur(6px); }'
                + '.evw-card { position:relative; z-index:1; background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%); border:1px solid rgba(212,175,55,0.3); border-radius:20px; padding:40px 36px; max-width:440px; width:90%; text-align:center; box-shadow:0 25px 60px rgba(0,0,0,0.5),0 0 40px rgba(212,175,55,0.1); animation:evwSlideIn 0.4s ease-out; }'
                + '@keyframes evwSlideIn { from{opacity:0;transform:translateY(-30px)scale(0.95)} to{opacity:1;transform:translateY(0)scale(1)} }'
                + '.evw-icon { font-size:56px; margin-bottom:16px; animation:evwBounce 2s infinite; }'
                + '@keyframes evwBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }'
                + '.evw-title { color:#d4af37; font-size:22px; font-weight:700; margin:0 0 12px; font-family:"Segoe UI",sans-serif; }'
                + '.evw-text { color:rgba(255,255,255,0.8); font-size:14px; margin:0 0 6px; line-height:1.5; }'
                + '.evw-sub { font-size:13px; color:rgba(255,255,255,0.5); margin-bottom:24px; }'
                + '.evw-email { color:#ffd700; font-size:16px; font-weight:600; margin:8px 0 12px; word-break:break-all; }'
                + '.evw-btn { display:block; width:100%; padding:14px; border:none; border-radius:12px; font-size:15px; font-weight:600; cursor:pointer; margin-bottom:12px; transition:all 0.2s; }'
                + '.evw-btn:hover { transform:translateY(-2px); }'
                + '.evw-btn:active { transform:translateY(0); }'
                + '.evw-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }'
                + '.evw-btn-primary { background:linear-gradient(135deg,#d4af37,#f5d060); color:#1a1a2e; box-shadow:0 4px 15px rgba(212,175,55,0.3); }'
                + '.evw-btn-primary:hover { box-shadow:0 6px 20px rgba(212,175,55,0.5); }'
                + '.evw-btn-secondary { background:transparent; border:1px solid rgba(212,175,55,0.3); color:#d4af37; }'
                + '.evw-btn-secondary:hover { background:rgba(212,175,55,0.1); }'
                + '.evw-status { min-height:20px; font-size:13px; margin:8px 0 4px; transition:all 0.3s; }'
                + '.evw-status.success { color:#4ade80; }'
                + '.evw-status.error { color:#f87171; }'
                + '.evw-status.info { color:#60a5fa; }'
                + '.evw-link { color:rgba(255,255,255,0.5); font-size:13px; text-decoration:none; transition:color 0.2s; }'
                + '.evw-link:hover { color:rgba(255,255,255,0.8); }'
                + '.evw-spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(26,26,46,0.3); border-top-color:#1a1a2e; border-radius:50%; animation:evwSpin 0.6s linear infinite; vertical-align:middle; margin-right:8px; }'
                + '@keyframes evwSpin { to{transform:rotate(360deg)} }';

            document.head.appendChild(style);
            document.body.appendChild(widget);
        }

        /**
         * Muestra el widget de verificaciÃ³n con el email del usuario.
         */
        function showEmailVerificationWidget(email) {
            ensureVerificationWidgetExists();
            document.getElementById('evwEmail').textContent = email;
            document.getElementById('evwStatus').textContent = '';
            document.getElementById('evwStatus').className = 'evw-status';
            document.getElementById('emailVerificationWidget').classList.add('active');
            isWaitingEmailVerification = true;
            console.log('ğŸ“§ [VERIFICATION WIDGET] Mostrado para: ' + email);
        }

        function hideEmailVerificationWidget() {
            var w = document.getElementById('emailVerificationWidget');
            if (w) w.classList.remove('active');
            isWaitingEmailVerification = false;
        }

        /**
         * BotÃ³n "Ya verifiquÃ© mi correo"
         * Recarga el estado del usuario desde Firebase y verifica emailVerified.
         */
        async function checkEmailVerified() {
            var btn = document.getElementById('btnCheckVerified');
            var status = document.getElementById('evwStatus');
            btn.disabled = true;
            btn.innerHTML = '<span class="evw-spinner"></span>Verificando...';
            status.textContent = '';
            status.className = 'evw-status';

            console.log('ğŸ“§ [VERIFICATION] Recargando estado del usuario...');

            try {
                var user = auth.currentUser;

                if (!user) {
                    console.error('âŒ [VERIFICATION] No hay usuario autenticado');
                    status.textContent = 'Error: sesiÃ³n no encontrada. Vuelve a registrarte.';
                    status.className = 'evw-status error';
                    btn.disabled = false;
                    btn.textContent = 'âœ… Ya verifiquÃ© mi correo';
                    return;
                }

                console.log('ğŸ“§ [VERIFICATION] UID: ' + user.uid + ' | emailVerified antes de reload: ' + user.emailVerified);

                // â”€â”€ Recargar datos del usuario desde Firebase Auth â”€â”€
                await user.reload();

                // â”€â”€ Re-obtener el usuario (reload() actualiza el objeto en memoria) â”€â”€
                user = auth.currentUser;

                console.log('ğŸ“§ [VERIFICATION] emailVerified despuÃ©s de reload: ' + user.emailVerified);

                if (user.emailVerified) {
                    console.log('âœ… [VERIFICATION] Â¡Email verificado exitosamente!');
                    status.textContent = 'Â¡Correo verificado! Redirigiendo al dashboard...';
                    status.className = 'evw-status success';

                    // â”€â”€ Actualizar Firestore: verified = true â”€â”€
                    try {
                        await db.collection('users').doc(user.uid).update({ verified: true });
                        console.log('âœ… [VERIFICATION] Firestore actualizado: verified = true');
                    } catch (fsErr) {
                        console.warn('âš ï¸ [VERIFICATION] No se pudo actualizar Firestore (no bloquea):', fsErr);
                    }

                    // â”€â”€ Redirigir (verificar perfil onboarding) â”€â”€
                    isWaitingEmailVerification = false;
                    await checkProfileAndRedirect(user, 'email', 1500);

                } else {
                    console.warn('âš ï¸ [VERIFICATION] Email aÃºn NO verificado');
                    status.textContent = 'Tu correo aÃºn no ha sido verificado. Revisa tu bandeja y haz clic en el enlace.';
                    status.className = 'evw-status error';
                    btn.disabled = false;
                    btn.textContent = 'âœ… Ya verifiquÃ© mi correo';
                }

            } catch (err) {
                console.error('âŒ [VERIFICATION] Error al verificar:', err);
                status.textContent = 'Error al verificar: ' + (err.message || err);
                status.className = 'evw-status error';
                btn.disabled = false;
                btn.textContent = 'âœ… Ya verifiquÃ© mi correo';
            }
        }

        /**
         * BotÃ³n "Reenviar correo de verificaciÃ³n"
         */
        async function resendVerificationEmail() {
            var btn = document.getElementById('btnResendVerification');
            var status = document.getElementById('evwStatus');
            btn.disabled = true;
            btn.innerHTML = '<span class="evw-spinner"></span>Enviando...';
            status.textContent = '';
            status.className = 'evw-status';

            console.log('ğŸ“§ [RESEND] Intentando reenviar correo de verificaciÃ³n...');

            try {
                var user = auth.currentUser;

                if (!user) {
                    console.error('âŒ [RESEND] No hay usuario autenticado');
                    status.textContent = 'Error: sesiÃ³n no encontrada.';
                    status.className = 'evw-status error';
                    btn.disabled = false;
                    btn.textContent = 'ğŸ”„ Reenviar correo de verificaciÃ³n';
                    return;
                }

                console.log('ğŸ“§ [RESEND] Enviando a: ' + user.email);

                await user.sendEmailVerification({
                    url: window.location.origin + '/login.html',
                    handleCodeInApp: false
                });

                console.log('âœ… [RESEND] Correo de verificaciÃ³n reenviado exitosamente a: ' + user.email);
                status.textContent = 'Â¡Correo reenviado! Revisa tu bandeja de entrada y spam.';
                status.className = 'evw-status success';

                // Cooldown de 30 segundos para evitar spam
                var countdown = 30;
                btn.textContent = 'Reenviar en ' + countdown + 's';
                var interval = setInterval(function() {
                    countdown--;
                    if (countdown <= 0) {
                        clearInterval(interval);
                        btn.disabled = false;
                        btn.textContent = 'ğŸ”„ Reenviar correo de verificaciÃ³n';
                    } else {
                        btn.textContent = 'Reenviar en ' + countdown + 's';
                    }
                }, 1000);

            } catch (err) {
                console.error('âŒ [RESEND] Error al reenviar:', err);

                if (err.code === 'auth/too-many-requests') {
                    status.textContent = 'Demasiados intentos. Espera unos minutos.';
                } else {
                    status.textContent = 'Error al reenviar: ' + (err.message || err);
                }
                status.className = 'evw-status error';
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ Reenviar correo de verificaciÃ³n';
            }
        }

        /**
         * "Volver al inicio de sesiÃ³n" â€” cierra sesiÃ³n y oculta widget
         */
        async function cancelVerificationAndLogout() {
            console.log('ğŸ“§ [VERIFICATION] Usuario cancelÃ³. Cerrando sesiÃ³n...');
            isWaitingEmailVerification = false;
            hideEmailVerificationWidget();
            try {
                await auth.signOut();
                console.log('âœ… [VERIFICATION] SesiÃ³n cerrada.');
            } catch (e) {
                console.warn('âš ï¸ [VERIFICATION] Error al cerrar sesiÃ³n:', e);
            }
            showView('login');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  GOOGLE SIGN-IN â€” Popup con fallback a Redirect
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function handleGoogleSignIn() {
            hideAlert();
            var btn = document.getElementById('btnGoogleLogin');
            if (btn) { btn.disabled = true; btn.textContent = 'Conectando...'; }

            debugLog('Iniciando Google Sign-In (popup)...');

            try {
                var result = await auth.signInWithPopup(googleProvider);
                var user = result.user;
                debugLog('âœ… Google popup exitoso! UID: ' + user.uid + ', email: ' + user.email);

                await saveUserToFirestore(user, { provider: 'google' });
                showAlert('success', 'Â¡Bienvenido! Verificando perfil...');
                await checkProfileAndRedirect(user, 'google', 1200);

            } catch (err) {
                debugError('Google popup error', err);

                if (err.code === 'auth/popup-blocked' ||
                    err.code === 'auth/popup-closed-by-user' ||
                    err.code === 'auth/cancelled-popup-request') {

                    debugLog('Popup bloqueado/cerrado, intentando redirect...');
                    showAlert('info', 'Redirigiendo a Google para autenticaciÃ³n...');

                    try {
                        await auth.signInWithRedirect(googleProvider);
                    } catch (redirectErr) {
                        debugError('Google redirect error', redirectErr);
                        showAlert('error', 'Error al redirigir a Google: ' + redirectErr.message);
                    }

                } else if (err.code === 'auth/account-exists-with-different-credential') {
                    showAlert('error', 'Ya existe una cuenta con ese email usando otro mÃ©todo. Intenta con email/contraseÃ±a o telÃ©fono.');

                } else if (err.code === 'auth/unauthorized-domain') {
                    showAlert('error', 'Este dominio no estÃ¡ autorizado en Firebase. Agrega "' + window.location.hostname + '" en Firebase Console â†’ Authentication â†’ Settings â†’ Authorized domains.');
                    debugError('UNAUTHORIZED DOMAIN', { hostname: window.location.hostname, origin: window.location.origin });

                } else if (err.code === 'auth/internal-error') {
                    showAlert('error', 'Error interno de Firebase. Verifica que el OAuth consent screen estÃ© configurado en Google Cloud Console.');

                } else if (err.code === 'auth/operation-not-allowed') {
                    showAlert('error', 'Google Sign-In no estÃ¡ habilitado. ActÃ­valo en Firebase Console â†’ Authentication â†’ Sign-in method â†’ Google.');

                } else {
                    showAlert('error', 'Error con Google: ' + translateFirebaseError(err.code));
                }
            }

            if (btn) { btn.disabled = false; btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg> Continuar con Google'; }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  LOGIN: EMAIL + PASSWORD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function handleLoginEmail() {
            hideAlert();
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginEmailPassword').value;

            if (!email) { showAlert('error', 'Ingresa tu email.'); return; }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showAlert('error', 'Email no vÃ¡lido.'); return; }
            if (!password) { showAlert('error', 'Ingresa tu contraseÃ±a.'); return; }

            setButtonLoading('btnLoginEmail', true);
            debugLog('Login email: ' + email);

            try {
                var result = await auth.signInWithEmailAndPassword(email, password);
                var user = result.user;
                debugLog('âœ… Login email OK. UID: ' + user.uid + ' | emailVerified: ' + user.emailVerified);

                // â”€â”€ NUEVO: Verificar si el email estÃ¡ confirmado â”€â”€
                if (!user.emailVerified) {
                    console.warn('âš ï¸ [LOGIN] Email no verificado. Mostrando widget...');
                    isRedirecting = true; // Bloquea onAuthStateChanged
                    await saveUserToFirestore(user, { provider: 'email' });
                    showEmailVerificationWidget(user.email);
                    setButtonLoading('btnLoginEmail', false);
                    return;
                }

                await saveUserToFirestore(user, { provider: 'email' });
                showAlert('success', 'Â¡Bienvenido de vuelta! Verificando perfil...');
                await checkProfileAndRedirect(user, 'email', 1200);

            } catch (err) {
                debugError('Login email error', err);
                if (err.code === 'auth/user-not-found') {
                    showAlert('error', 'No hay cuenta con ese email. Â¿Quieres registrarte?');
                } else if (err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
                    showAlert('error', 'ContraseÃ±a incorrecta.');
                } else {
                    showAlert('error', translateFirebaseError(err.code));
                }
            }
            setButtonLoading('btnLoginEmail', false);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  LOGIN: PHONE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function handleLoginPhone() {
            hideAlert();
            var phone = document.getElementById('loginPhone').value.trim();
            var password = document.getElementById('loginPhonePassword').value;

            if (!phone) { showAlert('error', 'Ingresa tu nÃºmero de telÃ©fono.'); return; }
            if (phone.replace(/\D/g, '').length < 10) { showAlert('error', 'El nÃºmero debe tener al menos 10 dÃ­gitos.'); return; }
            if (!password) { showAlert('error', 'Ingresa tu contraseÃ±a.'); return; }

            setButtonLoading('btnLoginPhone', true);
            var fullPhone = cleanPhoneNumber(phone);
            debugLog('Login phone: ' + fullPhone);

            try {
                var snapshot = await db.collection('users').where('phone', '==', fullPhone).limit(1).get();

                if (snapshot.empty) {
                    showAlert('error', 'No se encontrÃ³ cuenta con ese nÃºmero. Â¿Quieres registrarte?');
                    setButtonLoading('btnLoginPhone', false);
                    return;
                }

                var userData = snapshot.docs[0].data();
                debugLog('Usuario encontrado, email: ' + (userData.email || 'N/A'));

                if (userData.email) {
                    try {
                        var result = await auth.signInWithEmailAndPassword(userData.email, password);
                        debugLog('âœ… Login phoneâ†’email OK');
                        showAlert('success', 'Â¡Bienvenido de vuelta! Verificando perfil...');
                        await checkProfileAndRedirect(result.user, 'phone', 1200);
                    } catch (emailErr) {
                        debugError('Login phoneâ†’email error', emailErr);
                        if (emailErr.code === 'auth/wrong-password' || emailErr.code === 'auth/invalid-credential') {
                            showAlert('error', 'ContraseÃ±a incorrecta.');
                        } else {
                            showAlert('error', translateFirebaseError(emailErr.code));
                        }
                    }
                } else {
                    showAlert('info', 'VerificaciÃ³n por SMS necesaria...');
                    await sendLoginOTP(fullPhone);
                }
            } catch (err) {
                debugError('Login phone error', err);
                showAlert('error', 'Error: ' + (err.message || err));
            }
            setButtonLoading('btnLoginPhone', false);
        }

        async function sendLoginOTP(phoneNumber) {
            try {
                recaptchaVerifierLogin = safeResetRecaptcha(recaptchaVerifierLogin);
                recaptchaVerifierLogin = setupRecaptchaInvisible('btnLoginPhone');
                confirmationResultLogin = await auth.signInWithPhoneNumber(phoneNumber, recaptchaVerifierLogin);
                document.getElementById('loginPhoneVerify').classList.add('active');
                document.getElementById('btnLoginPhone').style.display = 'none';
                document.getElementById('loginVerifyPhone').textContent = phoneNumber;
                showAlert('success', 'CÃ³digo SMS enviado.');
                clearOTP('loginOtpGroup');
                document.querySelector('#loginOtpGroup .otp-digit').focus();
            } catch (err) {
                debugError('SMS login error', err);
                showAlert('error', 'Error SMS: ' + translateFirebaseError(err.code));
                recaptchaVerifierLogin = safeResetRecaptcha(recaptchaVerifierLogin);
            }
        }

        async function verifyLoginOTP() {
            var code = getOTPValue('loginOtpGroup');
            if (code.length !== 6) { showAlert('error', 'CÃ³digo de 6 dÃ­gitos requerido.'); return; }
            setButtonLoading('btnVerifyLogin', true);
            try {
                var result = await confirmationResultLogin.confirm(code);
                debugLog('âœ… Login OTP OK');
                await saveUserToFirestore(result.user, { provider: 'phone' });
                showAlert('success', 'Â¡Verificado! Redirigiendo...');
                await checkProfileAndRedirect(result.user, 'phone', 1200);
            } catch (err) {
                showAlert('error', 'CÃ³digo incorrecto.');
                clearOTP('loginOtpGroup');
            }
            setButtonLoading('btnVerifyLogin', false);
        }

        function resendLoginCode() {
            sendLoginOTP(cleanPhoneNumber(document.getElementById('loginPhone').value.trim()));
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  REGISTER: EMAIL â€” CON VERIFICACIÃ“N OBLIGATORIA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function handleRegisterEmail() {
            hideAlert();
            var name     = document.getElementById('regEmailName').value.trim();
            var email    = document.getElementById('regEmail').value.trim();
            var password = document.getElementById('regEmailPassword').value;
            var phone    = document.getElementById('regEmailPhone').value.trim();

            if (!name) { showAlert('error', 'Ingresa tu nombre.'); return; }
            if (!email) { showAlert('error', 'Ingresa tu email.'); return; }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showAlert('error', 'Email no vÃ¡lido.'); return; }
            if (!password) { showAlert('error', 'Ingresa una contraseÃ±a.'); return; }
            if (password.length < 6) { showAlert('error', 'MÃ­nimo 6 caracteres.'); return; }

            setButtonLoading('btnRegisterEmail', true);
            debugLog('Register email: ' + email);

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // âœ… CRITICAL FIX: Bloquear auto-redirect ANTES de crear usuario
            // Sin esto, onAuthStateChanged redirige al dashboard instantÃ¡neamente
            // y sendEmailVerification nunca se ejecuta.
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            isRedirecting = true;

            try {
                // â”€â”€ Paso 1: Crear usuario â”€â”€
                var result = await auth.createUserWithEmailAndPassword(email, password);
                var user = result.user;
                console.log('âœ… [REGISTER] Cuenta creada. UID: ' + user.uid);
                console.log('âœ… [REGISTER] emailVerified: ' + user.emailVerified);

                // â”€â”€ Paso 2: Actualizar displayName â”€â”€
                try {
                    await user.updateProfile({ displayName: name });
                    console.log('âœ… [REGISTER] displayName actualizado: ' + name);
                } catch(e) {
                    console.warn('âš ï¸ [REGISTER] Error al actualizar displayName:', e);
                }

                // â”€â”€ Paso 3: Enviar email de verificaciÃ³n â”€â”€
                var emailSent = false;
                try {
                    console.log('ğŸ“§ [REGISTER] Enviando email de verificaciÃ³n a: ' + email + '...');
                    await user.sendEmailVerification({
                        url: window.location.origin + '/login.html',
                        handleCodeInApp: false
                    });
                    emailSent = true;
                    console.log('âœ… [REGISTER] Â¡Email de verificaciÃ³n enviado exitosamente a: ' + email + '!');
                } catch (verifyErr) {
                    console.error('âŒ [REGISTER] ERROR al enviar email de verificaciÃ³n:', verifyErr);
                    console.error('âŒ [REGISTER] Error code:', verifyErr.code || 'N/A');
                    console.error('âŒ [REGISTER] Error message:', verifyErr.message || 'N/A');
                    debugError('sendEmailVerification FALLÃ“', verifyErr);
                }

                // â”€â”€ Paso 4: Guardar en Firestore â”€â”€
                await saveUserToFirestore(user, {
                    name: name, email: email,
                    phone: phone ? cleanPhoneNumber(phone) : '',
                    provider: 'email'
                });

                // â”€â”€ Paso 5: Mostrar widget de verificaciÃ³n (NO redirigir) â”€â”€
                if (emailSent) {
                    console.log('ğŸ“§ [REGISTER] Mostrando widget de verificaciÃ³n...');
                    showEmailVerificationWidget(email);
                } else {
                    // Si no se pudo enviar, intenta una vez mÃ¡s
                    console.warn('âš ï¸ [REGISTER] Reintentando envÃ­o de email...');
                    try {
                        await user.sendEmailVerification({
                            url: window.location.origin + '/login.html',
                            handleCodeInApp: false
                        });
                        console.log('âœ… [REGISTER] Email enviado en segundo intento');
                        showEmailVerificationWidget(email);
                    } catch (retryErr) {
                        console.error('âŒ [REGISTER] Segundo intento tambiÃ©n fallÃ³:', retryErr);
                        showAlert('error', 'No pudimos enviar el correo de verificaciÃ³n. Intenta iniciar sesiÃ³n y reenviar.');
                        isRedirecting = false; // Desbloquear
                    }
                }

            } catch (err) {
                // â”€â”€ Si falla la creaciÃ³n de cuenta, desbloquear auto-redirect â”€â”€
                isRedirecting = false;
                debugError('Register email error', err);

                if (err.code === 'auth/email-already-in-use') {
                    showAlert('error', 'Ya existe cuenta con ese email. Â¿Quieres iniciar sesiÃ³n?');
                } else if (err.code === 'auth/weak-password') {
                    showAlert('error', 'ContraseÃ±a muy dÃ©bil. Usa al menos 6 caracteres.');
                } else {
                    showAlert('error', translateFirebaseError(err.code));
                }
            }
            setButtonLoading('btnRegisterEmail', false);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  REGISTER: PHONE + OTP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function handleRegisterPhone() {
            hideAlert();
            var name     = document.getElementById('regPhoneName').value.trim();
            var phone    = document.getElementById('regPhone').value.trim();
            var password = document.getElementById('regPhonePassword').value;
            var email    = document.getElementById('regPhoneEmail').value.trim();

            if (!name) { showAlert('error', 'Ingresa tu nombre.'); return; }
            if (!phone || phone.replace(/\D/g, '').length < 10) { showAlert('error', 'TelÃ©fono vÃ¡lido requerido.'); return; }
            if (!password) { showAlert('error', 'Ingresa una contraseÃ±a.'); return; }
            if (password.length < 6) { showAlert('error', 'MÃ­nimo 6 caracteres.'); return; }

            pendingRegPhoneData = { name: name, phone: cleanPhoneNumber(phone), password: password, email: email };
            setButtonLoading('btnRegisterPhone', true);
            debugLog('Register phone: ' + pendingRegPhoneData.phone);

            try {
                recaptchaVerifierRegister = safeResetRecaptcha(recaptchaVerifierRegister);
                recaptchaVerifierRegister = setupRecaptchaInvisible('btnRegisterPhone');
                confirmationResultRegister = await auth.signInWithPhoneNumber(pendingRegPhoneData.phone, recaptchaVerifierRegister);
                document.getElementById('registerPhoneVerify').classList.add('active');
                document.getElementById('btnRegisterPhone').style.display = 'none';
                document.getElementById('regVerifyPhone').textContent = pendingRegPhoneData.phone;
                showAlert('success', 'CÃ³digo SMS enviado.');
                clearOTP('regOtpGroup');
                document.querySelector('#regOtpGroup .otp-digit').focus();
            } catch (err) {
                debugError('Register phone SMS error', err);
                showAlert('error', 'Error SMS: ' + translateFirebaseError(err.code));
                recaptchaVerifierRegister = safeResetRecaptcha(recaptchaVerifierRegister);
            }
            setButtonLoading('btnRegisterPhone', false);
        }

        async function verifyRegisterOTP() {
            var code = getOTPValue('regOtpGroup');
            if (code.length !== 6) { showAlert('error', 'CÃ³digo de 6 dÃ­gitos requerido.'); return; }
            setButtonLoading('btnVerifyRegister', true);

            try {
                var result = await confirmationResultRegister.confirm(code);
                var phoneUser = result.user;
                debugLog('âœ… OTP registro OK. UID: ' + phoneUser.uid);

                var emailForLink = pendingRegPhoneData.email || pendingRegPhoneData.phone.replace('+', '') + '@dontrading.app';
                if (pendingRegPhoneData.password) {
                    try {
                        var cred = firebase.auth.EmailAuthProvider.credential(emailForLink, pendingRegPhoneData.password);
                        await phoneUser.linkWithCredential(cred);
                        debugLog('âœ… Email linked');
                    } catch (e) { debugError('Link email (no bloquea)', e); }
                }

                try { await phoneUser.updateProfile({ displayName: pendingRegPhoneData.name }); } catch(e) { /* silent */ }

                await saveUserToFirestore(phoneUser, {
                    name: pendingRegPhoneData.name, phone: pendingRegPhoneData.phone,
                    email: emailForLink, provider: 'phone'
                });

                showAlert('success', 'Â¡Cuenta creada! Completando perfil...');
                await checkProfileAndRedirect(phoneUser, 'phone', 1500);

            } catch (err) {
                debugError('Verify register error', err);
                if (err.code === 'auth/invalid-verification-code') {
                    showAlert('error', 'CÃ³digo incorrecto.');
                    clearOTP('regOtpGroup');
                } else {
                    showAlert('error', translateFirebaseError(err.code));
                }
            }
            setButtonLoading('btnVerifyRegister', false);
        }

        function resendRegisterCode() { handleRegisterPhone(); }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â–ˆâ–ˆ  RECOVERY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function handleRecovery() {
            hideAlert();
            var email = document.getElementById('recoveryEmail').value.trim();
            if (!email) { showAlert('error', 'Ingresa tu email.'); return; }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showAlert('error', 'Email no vÃ¡lido.'); return; }

            setButtonLoading('btnRecovery', true);
            try {
                await auth.sendPasswordResetEmail(email);
                showAlert('success', 'Â¡Enlace enviado! Revisa tu bandeja en ' + email + ' (y carpeta de spam).');
            } catch (err) {
                if (err.code === 'auth/user-not-found') {
                    showAlert('error', 'No hay cuenta con ese email.');
                } else {
                    showAlert('error', translateFirebaseError(err.code));
                }
            }
            setButtonLoading('btnRecovery', false);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ERROR TRANSLATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function translateFirebaseError(code) {
            var m = {
                'auth/invalid-phone-number':       'NÃºmero de telÃ©fono no vÃ¡lido.',
                'auth/too-many-requests':          'Demasiados intentos. Espera un momento.',
                'auth/quota-exceeded':             'LÃ­mite de SMS excedido.',
                'auth/invalid-verification-code':  'CÃ³digo incorrecto.',
                'auth/code-expired':               'CÃ³digo expirado. Solicita otro.',
                'auth/user-not-found':             'Cuenta no encontrada.',
                'auth/wrong-password':             'ContraseÃ±a incorrecta.',
                'auth/invalid-credential':         'Credenciales invÃ¡lidas.',
                'auth/email-already-in-use':       'Email ya registrado.',
                'auth/weak-password':              'ContraseÃ±a muy dÃ©bil (mÃ­n. 6 chars).',
                'auth/network-request-failed':     'Sin conexiÃ³n. Verifica tu internet.',
                'auth/popup-closed-by-user':       'Ventana cerrada. Intenta de nuevo.',
                'auth/popup-blocked':              'Popup bloqueado por el navegador.',
                'auth/captcha-check-failed':       'Error reCAPTCHA.',
                'auth/missing-phone-number':       'TelÃ©fono requerido.',
                'auth/credential-already-in-use':  'Credencial ya asociada a otra cuenta.',
                'auth/billing-not-enabled':        'Plan Blaze no activo en Firebase.',
                'auth/operation-not-allowed':      'Proveedor no habilitado en Firebase Console.',
                'auth/unauthorized-domain':        'Dominio no autorizado en Firebase.',
                'auth/account-exists-with-different-credential': 'Cuenta existente con otro mÃ©todo.',
                'auth/internal-error':             'Error interno. Verifica OAuth consent screen en Google Cloud.'
            };
            return m[code] || 'Error (' + code + ')';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTH STATE OBSERVER â€” ACTUALIZADO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        auth.onAuthStateChanged(function(user) {
            if (user && !isRedirecting && !isWaitingEmailVerification) {
                debugLog('ğŸ‘¤ Auth state: ' + user.uid + ' (' + (user.email || user.phoneNumber || 'google') + ') | emailVerified: ' + user.emailVerified);

                var isVerifying = document.getElementById('registerPhoneVerify').classList.contains('active')
                            || document.getElementById('loginPhoneVerify').classList.contains('active');

                if (!isVerifying) {
                    // â”€â”€ NUEVO: Si es proveedor email y no ha verificado, mostrar widget â”€â”€
                    var isEmailProvider = user.providerData.some(function(p) { return p.providerId === 'password'; });
                    var isGoogleProvider = user.providerData.some(function(p) { return p.providerId === 'google.com'; });

                    if (isEmailProvider && !isGoogleProvider && !user.emailVerified) {
                        console.warn('âš ï¸ [AUTH OBSERVER] Email no verificado. Mostrando widget en lugar de redirigir.');
                        isRedirecting = true;
                        showEmailVerificationWidget(user.email);
                        return;
                    }

                    debugLog('ğŸš€ Auto-redirect: ya autenticado y verificado. Verificando perfil...');
                    checkProfileAndRedirect(user, detectProvider(user), 800);
                }
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        console.log('ğŸ” DONTRADING Login v3.0 â€” Onboarding + Email Verification');
        console.log('ğŸ“§ Email: âœ…  |  ğŸ“± Phone: âœ…  |  ğŸ”µ Google: âœ…  |  ğŸ“ Onboarding: âœ…');
        console.log('ğŸŒ Domain: ' + window.location.hostname);
        console.log('ğŸ”— Origin: ' + window.location.origin);
        console.log('ğŸ”¥ authDomain: ' + firebaseConfig.authDomain);
        debugLog('Page loaded. Domain: ' + window.location.hostname);
    </script>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
</body>
</html>